<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FasTPV</title>
    
    <!-- 1. Estilos (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ConfiguraciÃ³n de Iconos y LibrerÃ­as -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- LibrerÃ­a para escanear con cÃ¡mara (QR/Barras) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- LibrerÃ­a para Tablas en PDF (AutoTable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- 3. React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Usamos la versiÃ³n minificada para producciÃ³n. Recuerda minificar styles.css al editar -->
    <link rel="stylesheet" href="styles.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
</head>
<!-- FONDO GRIS PLATEADO OSCURO -->
<body class="bg-[#f2f2f7] text-slate-800 selection:bg-blue-500 selection:text-white transition-colors duration-300">
    <div id="root"></div>

    <!-- 4. TU CÃ“DIGO DEL SISTEMA -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // --- CONSTANTES ---
// Utilizamos window para almacenar variables globales solo si no existen aÃºn, evitando redeclaraciÃ³n
        window.SISTEMA = window.SISTEMA || "FasTPV v1.0";
        window.COLOR_CORP = window.COLOR_CORP || "bg-slate-900 text-white shadow-lg border-b border-slate-800 transition-colors duration-300";
        window.RATIO_PUNTOS = window.RATIO_PUNTOS || 10;
        
        // --- SONIDOS DEL SISTEMA ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);

                if (type === 'warning') { // Alarma Suave
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(440, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                } else if (type === 'alarm') { // Alarma Fuerte
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.5);
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
                    osc.start();
                    osc.stop(ctx.currentTime + 1);
                } else if (type === 'scan') { // Beep de Escaneo
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(1200, ctx.currentTime);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.1);
                } else if (type === 'success') { // Ã‰xito (Venta)
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.1, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.3);
                }
            } catch (e) { console.error("Audio error", e); }
        };

        // --- ADAPTADOR DE ICONOS LUCIDE ---
        const LucideIconWrapper = React.memo(({ name, size = 24, className = "", ...props }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    const kebabName = name.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
                    const iTag = document.createElement('i');
                    iTag.setAttribute('data-lucide', kebabName);
                    if (className) iTag.className = className;
                    ref.current.innerHTML = '';
                    ref.current.appendChild(iTag);
                    window.lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size, class: `lucide lucide-${kebabName} ${className}` }
                    });
                }
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }} {...props}></span>;
        });

        const iconNames = [
            'Monitor', 'Gamepad2', 'Play', 'Pause', 'Square', 'Coffee', 'Printer', 'X', 
            'DollarSign', 'ShoppingBag', 'Users', 'Ticket', 'PlusCircle', 'CheckCircle', 
            'Percent', 'Save', 'Package', 'Trash2', 'Edit2', 'AlertTriangle', 'AlertCircle',
            'Settings', 'Wifi', 'Smartphone', 'UserPlus', 'Star', 'Trophy', 'ArrowRightLeft', 
            'Ban', 'Lock', 'LogOut', 'Truck', 'ScanBarcode', 'UserCog', 'Shield',
            'Clock', 'Timer', 'Bell', 'Key', 'FileText', 'Bluetooth', 'Camera', 'CameraOff', 'QrCode', 'Droplet', 'ChevronRight', 'CircleDollarSign', 'RotateCcw', 'Store', 'HandHelping', 'Database', 'Download', 'Upload', 'Wallet',
            'Info', 'MapPin', 'Building', 'Minus', 'History', 'FileClock'
        ];

        const Icons = {};
        iconNames.forEach(name => { Icons[name] = (props) => <LucideIconWrapper name={name} {...props} />; });
        const { Monitor, Gamepad2, Play, Pause, Square, Coffee, X, ShoppingBag, Users, Ticket, PlusCircle, CheckCircle, Package, Trash2, Edit2, Settings, Ban, Lock, LogOut, Truck, ScanBarcode, UserCog, Shield, Clock, Timer, Bell, Trophy, ArrowRightLeft, Key, Save, Printer, FileText, Bluetooth, Camera, CameraOff, QrCode, Droplet, ChevronRight, CircleDollarSign, RotateCcw, Store, Wifi, HandHelping, UserPlus, Database, Download, Upload, AlertTriangle, Wallet, DollarSign, Percent, AlertCircle, Smartphone, Star, Info, MapPin, Building, Minus, History, FileClock } = Icons;

        // --- DATOS INICIALES ---
        const USUARIOS_DEFAULT = [
            { id: 1, nombre: 'Administrador', pin: '1234', rol: 'admin' },
            { id: 2, nombre: 'Empleado Turno 1', pin: '0000', rol: 'empleado' }
        ];
        const CLIENTES_INICIALES = [{ id: 1, nombre: 'Cliente General', puntos: 0, cupones: [] }];
        const EQUIPOS_INICIALES = [
            { id: 1, tipo: 'PC', nombre: 'EstaciÃ³n 01', estado: 'libre', precioHora: 15.00 },
            { id: 2, tipo: 'PC', nombre: 'EstaciÃ³n 02', estado: 'libre', precioHora: 15.00 },
            { id: 3, tipo: 'PC', nombre: 'EstaciÃ³n 03', estado: 'libre', precioHora: 15.00 },
            { id: 4, tipo: 'PC', nombre: 'EstaciÃ³n 04', estado: 'libre', precioHora: 15.00 },
            { id: 5, tipo: 'CONSOLA', nombre: 'Xbox Series S', estado: 'libre', precioHora: 20.00 },
            { id: 6, tipo: 'CONSOLA', nombre: 'PlayStation 5', estado: 'libre', precioHora: 20.00 },
        ];
        const PRODUCTOS_BASE_DEFAULT = [
            { id: 1, nombre: 'Coca Cola 600ml', precio: 18.00, icon: 'ðŸ¥¤', stock: 24, categoria: 'Bebidas', codigo: '7501055300075' },
            { id: 2, nombre: 'Papas Sabritas', precio: 16.00, icon: 'ðŸŸ', stock: 15, categoria: 'Snacks', codigo: '7501011123456' },
        ];
        const CONFIG_INICIAL = {
            tarifaMinima: 5.00,
            formatoTicket: '58mm', // '58mm' o 'LETTER'
            negocio: {
                nombre: "FasTPV Generic",
                rfc: "XAXX010101000",
                regimen: "RÃ©gimen General de Ley",
                direccion: "Calle Conocida S/N, Centro",
                lugarExpedicion: "MÃ©xico"
            },
            ticketConfig: {
                headers: { cant: 'Cant', desc: 'Desc', pu: 'P.U.', importe: 'Importe' },
                separador: '-',
                mensajeFinal: 'Â¡Gracias por su preferencia!'
            },
            precios: {
                impresion: {
                    bn: { B: 2.00, M: 5.00, G: 8.00 },
                    color: { B: 3.00, M: 7.00, G: 12.00 }
                },
                extras: {
                    oficio: 1.00, // Se suma
                    tabloide: 2.00 // Se multiplica
                },
                otros: {
                    escaneo: { carta: 4.00, oficio: 5.00 },
                    envio: 5.00,
                    wifi: 10.00,
                    asesoria: 15.00
                }
            }
        };

        // --- COMPONENTE LOGIN ---
        const LoginScreen = ({ onLogin, usuarios, empresa }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState(false);

            const handleNum = (num) => { 
                if (pin.length < 4) setPin(prev => prev + num); 
                setError(false); 
            };
            const handleClear = () => { setPin(''); setError(false); };
            const handleSubmit = () => {
                const user = usuarios.find(u => u.pin === pin);
                if (user) onLogin(user);
                else { setError(true); setPin(''); setTimeout(() => setError(false), 1000); }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') handleSubmit();
            };

            return (
                <div className="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100] overflow-hidden">
                    <div className="absolute inset-0 bg-slate-200 backdrop-blur-3xl"></div>
                    <div className="bg-white/80 backdrop-blur-2xl p-8 rounded-3xl shadow-2xl w-full max-w-sm modal-anim border border-white/60 relative z-10 transition-colors">
                        <div className="text-center mb-6">
                            <div className="bg-white/50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner transition-colors">
                                <Lock className="text-slate-700" size={32} />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800">{empresa}</h2>
                            <p className="text-slate-400 text-sm">Sistema de Control</p>
                        </div>
                        
                        <div className="mb-6">
                            <input 
                                type="password" 
                                value={pin} 
                                onChange={(e) => {
                                    if(e.target.value.length <= 4 && /^\d*$/.test(e.target.value)) setPin(e.target.value);
                                    setError(false);
                                }}
                                onKeyDown={handleKeyDown}
                                className={`w-full text-center text-3xl tracking-[1em] border-b border-slate-300 py-2 focus:outline-none focus:border-blue-500 bg-transparent transition-all ${error ? 'border-rose-500 text-rose-500' : 'text-slate-800'}`}
                                placeholder="â€¢â€¢â€¢â€¢"
                                autoFocus
                            />
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-4">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                                <button key={n} onClick={() => handleNum(n)} className="h-14 rounded-2xl bg-white/50 hover:bg-white border border-white/50 shadow-sm active:scale-95 font-medium text-xl text-slate-700 transition-all">{n}</button>
                            ))}
                            <button onClick={handleClear} className="h-14 rounded-2xl bg-rose-50 text-rose-600 font-bold hover:bg-rose-100 border border-rose-100 active:scale-95 transition-all">C</button>
                            <button onClick={() => handleNum(0)} className="h-14 rounded-2xl bg-white/50 hover:bg-white border border-white/50 shadow-sm active:scale-95 font-medium text-xl text-slate-700 transition-all">{0}</button>
                            <button onClick={handleSubmit} className="h-14 rounded-2xl bg-blue-500 text-white font-bold hover:bg-blue-600 shadow-lg shadow-blue-500/30 active:scale-95 flex justify-center items-center transition-all"><ArrowRightLeft size={20} /></button>
                        </div>
                        {error && <p className="text-center text-rose-500 text-sm font-bold animate-pulse">PIN Incorrecto</p>}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---
        function CiberManager() {
            // STATES
            const [usuarioActual, setUsuarioActual] = useState(null);
            const [usuarios, setUsuarios] = useState(() => JSON.parse(localStorage.getItem('sys-usuarios')) || USUARIOS_DEFAULT);
            const [equipos, setEquipos] = useState(() => {
                const s = localStorage.getItem('sys-equipos');
                return s ? JSON.parse(s) : EQUIPOS_INICIALES.map(e => ({ ...e, inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false }));
            });
            const [catalogo, setCatalogo] = useState(() => JSON.parse(localStorage.getItem('sys-catalogo')) || PRODUCTOS_BASE_DEFAULT);
            const [ventas, setVentas] = useState(() => JSON.parse(localStorage.getItem('sys-ventas')) || []);
            const [clientes, setClientes] = useState(() => JSON.parse(localStorage.getItem('sys-clientes')) || CLIENTES_INICIALES);
            const [cortes, setCortes] = useState(() => JSON.parse(localStorage.getItem('sys-cortes')) || []);
            
            // CONFIG Y CAJA
            const [config, setConfig] = useState(() => {
                try {
                    const saved = JSON.parse(localStorage.getItem('sys-config'));
                    // Merge profundo bÃ¡sico para asegurar que existan los precios si la config es antigua
                    const base = { ...CONFIG_INICIAL };
                    if (saved) {
                        base.tarifaMinima = saved.tarifaMinima ?? base.tarifaMinima;
                        base.formatoTicket = saved.formatoTicket ?? base.formatoTicket;
                        if (saved.negocio) {
                            base.negocio = { ...base.negocio, ...saved.negocio };
                        }
                        if (saved.ticketConfig) {
                            base.ticketConfig = { 
                                ...base.ticketConfig, 
                                ...saved.ticketConfig,
                                headers: { ...base.ticketConfig.headers, ...(saved.ticketConfig.headers || {}) }
                            };
                        }
                        if (saved.precios) {
                            // Merge profundo seguro para evitar errores si faltan claves en la config guardada
                            base.precios = {
                                ...base.precios,
                                ...saved.precios,
                                impresion: {
                                    ...base.precios.impresion,
                                    ...(saved.precios.impresion || {}),
                                    bn: { ...base.precios.impresion.bn, ...(saved.precios.impresion?.bn || {}) },
                                    color: { ...base.precios.impresion.color, ...(saved.precios.impresion?.color || {}) }
                                },
                                extras: { ...base.precios.extras, ...(saved.precios.extras || {}) },
                                otros: { ...base.precios.otros, ...(saved.precios.otros || {}) }
                            };
                        }
                    }
                    return base;
                } catch (e) {
                    console.error("Error cargando config", e);
                    return { ...CONFIG_INICIAL };
                }
            });
            const [caja, setCaja] = useState(() => JSON.parse(localStorage.getItem('sys-caja')) || { activa: false, fondo: 0, inicio: null });

            // NUEVO STATE: CARRITO DE VENTA DIRECTA
            const [carritoDirecto, setCarritoDirecto] = useState([]);
            const [ventaDirectaClienteId, setVentaDirectaClienteId] = useState(1);
            const [mostrarNuevoCliente, setMostrarNuevoCliente] = useState(false);
            const [nuevoClienteNombre, setNuevoClienteNombre] = useState('');
            const [pagoConDirecto, setPagoConDirecto] = useState(''); 
            const [busquedaDirecta, setBusquedaDirecta] = useState('');
            const [busquedaEstacion, setBusquedaEstacion] = useState('');
            
            // TOASTS SYSTEM
            const [toasts, setToasts] = useState([]);
            const addToast = (msg, type = 'info') => {
                const id = Date.now() + Math.random();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
            
            // UI Modals
            const [modalAbierto, setModalAbierto] = useState(null); 
            const [equipoSeleccionadoId, setEquipoSeleccionadoId] = useState(null); 
            const [confirmarResetId, setConfirmarResetId] = useState(null); 
            const [checkoutData, setCheckoutData] = useState({ clienteId: 1, pagoCon: '' }); 
            const [prepagoData, setPrepagoData] = useState({ dinero: '', minutos: '' });
            const [pinData, setPinData] = useState({ nuevo: '', confirmar: '' });
            const [cajaForm, setCajaForm] = useState({ fondo: '' }); // Formulario para abrir caja
            const [showCamera, setShowCamera] = useState(false); 
            const [procesando, setProcesando] = useState(false);
            
            // Estado para servicios (Impresiones, etc)
            const [servicioForm, setServicioForm] = useState({ tipo: 'IMPRESION_BN', tamano: 'CARTA', cobertura: 'B', cantidad: 1 });
            const [manualItemForm, setManualItemForm] = useState({ nombre: '', precio: '' });

            // Forms
            const [itemForm, setItemForm] = useState({ id: null, nombre: '', precio: '', stock: '', categoria: 'General', codigo: '' });
            const [usuarioForm, setUsuarioForm] = useState({ nombre: '', pin: '', rol: 'empleado' });
            const [clienteForm, setClienteForm] = useState({ nombre: '' });
            const [estacionForm, setEstacionForm] = useState({ id: null, nombre: '', tipo: 'PC', precioHora: '' });

            // Buffer Scanner
            const barcodeBuffer = useRef('');
            const lastKeyTime = useRef(0);
            const html5QrCodeRef = useRef(null);

            // --- EFFECTS ---
            useEffect(() => {
                localStorage.setItem('sys-equipos', JSON.stringify(equipos));
                localStorage.setItem('sys-ventas', JSON.stringify(ventas));
                localStorage.setItem('sys-catalogo', JSON.stringify(catalogo));
                localStorage.setItem('sys-clientes', JSON.stringify(clientes));
                localStorage.setItem('sys-usuarios', JSON.stringify(usuarios));
                localStorage.setItem('sys-config', JSON.stringify(config));
                localStorage.setItem('sys-caja', JSON.stringify(caja));
                localStorage.setItem('sys-cortes', JSON.stringify(cortes));
            }, [equipos, ventas, catalogo, clientes, usuarios, config, caja, cortes]);

            // SEGURIDAD
            useEffect(() => {
                if (usuarioActual && usuarioActual.id === 1 && usuarioActual.pin === '1234' && modalAbierto !== 'cambiar_pin') {
                    setTimeout(() => {
                        addToast("âš ï¸ ADVERTENCIA DE SEGURIDAD\nEstÃ¡s utilizando la contraseÃ±a predeterminada (1234).\nPor favor, cÃ¡mbiala ahora.", 'warning');
                        setModalAbierto('cambiar_pin');
                    }, 500);
                }
            }, [usuarioActual]);

            // TIMER LOOP
            useEffect(() => {
                const interval = setInterval(() => {
                    setEquipos(prev => prev.map(eq => {
                        if (eq.estado === 'ocupado' && eq.inicio) {
                            const tiempoTranscurrido = eq.tiempoAcumulado + (Date.now() - eq.inicio);
                            let newState = { ...eq, _tick: Date.now() };

                            if (eq.modo === 'prepago' && eq.limiteTiempo > 0) {
                                const restante = eq.limiteTiempo - tiempoTranscurrido;
                                if (restante <= 60000 && restante > 0 && !eq.alertaMinuto) {
                                    playSound('warning');
                                    newState.alertaMinuto = true;
                                }
                                if (restante <= 0) {
                                    playSound('alarm');
                                    newState.estado = 'finalizado'; 
                                    newState.inicio = null;
                                    newState.tiempoAcumulado = eq.limiteTiempo;
                                    newState.alertaMinuto = false;
                                }
                            }
                            return newState;
                        }
                        return eq;
                    }));
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            // --- CAMERA ---
            useEffect(() => {
                if (showCamera && (modalAbierto === 'inventario')) {
                    const startCamera = async () => {
                        try {
                            const Html5Qrcode = window.Html5Qrcode;
                            if(!Html5Qrcode) return addToast("LibrerÃ­a QR no cargada", 'error');
                            const html5QrCode = new Html5Qrcode("reader");
                            html5QrCodeRef.current = html5QrCode;
                            await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (t, r) => handleBarcodeScan(t), (e) => {});
                        } catch (err) { addToast("Error al iniciar cÃ¡mara: " + err, 'error'); setShowCamera(false); }
                    };
                    setTimeout(startCamera, 100);
                } else { stopCamera(); }
                return () => stopCamera();
            }, [showCamera, modalAbierto]);

            const stopCamera = async () => {
                if (html5QrCodeRef.current) {
                    try { await html5QrCodeRef.current.stop(); html5QrCodeRef.current.clear(); } catch(e) {}
                    html5QrCodeRef.current = null;
                }
            };

            // --- BARCODE ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    const currentTime = Date.now();
                    if (currentTime - lastKeyTime.current > 100) barcodeBuffer.current = '';
                    lastKeyTime.current = currentTime;
                    if (e.key === 'Enter') {
                        if (barcodeBuffer.current.length > 0) { handleBarcodeScan(barcodeBuffer.current); barcodeBuffer.current = ''; }
                    } else if (e.key.length === 1 && document.activeElement.tagName !== 'INPUT') { barcodeBuffer.current += e.key; }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [modalAbierto, catalogo, carritoDirecto]);

            const handleBarcodeScan = (code) => {
                playSound('scan');
                if (modalAbierto === 'productos' || modalAbierto === 'venta_directa') {
                    const producto = catalogo.find(p => p.codigo === code);
                    if (producto && producto.stock > 0) {
                        if (modalAbierto === 'venta_directa') {
                            agregarProductoDirecto(producto);
                        } else {
                            agregarProductoACuenta(producto, false);
                        }
                    }
                    else addToast(producto ? "Â¡Sin stock!" : "Producto no encontrado.", 'error');
                } else if (modalAbierto === 'inventario') {
                    const producto = catalogo.find(p => p.codigo === code);
                    if (producto) setItemForm(producto);
                    else {
                        setItemForm({ id: null, nombre: '', precio: '', stock: '', categoria: 'General', codigo: code, icon: 'ðŸ“¦' });
                        playSound('warning');
                    }
                }
            };

            // --- HELPER: CALCULADORA DE PRECIOS DINÃMICA ---
            const calcularPrecio = useCallback((tipo, tamano, cobertura, cantidad) => {
                const p = config.precios;
                let unitario = 0;
                if (tipo === 'IMPRESION_BN') {
                    const base = p.impresion.bn[cobertura] || 0;
                    if (tamano === 'OFICIO') unitario = base + p.extras.oficio;
                    else if (tamano === 'TABLOIDE') unitario = base * p.extras.tabloide;
                    else unitario = base;
                } else if (tipo === 'IMPRESION_COLOR') {
                    const base = p.impresion.color[cobertura] || 0;
                    if (tamano === 'OFICIO') unitario = base + p.extras.oficio;
                    else if (tamano === 'TABLOIDE') unitario = base * p.extras.tabloide;
                    else unitario = base;
                } else if (tipo === 'ESCANEO') unitario = tamano === 'OFICIO' ? p.otros.escaneo.oficio : p.otros.escaneo.carta;
                else if (tipo === 'ENVIO') unitario = p.otros.envio;
                else if (tipo === 'WIFI') unitario = p.otros.wifi;
                else if (tipo === 'ASESORIA') unitario = p.otros.asesoria;

                if (cantidad > 10 && tipo !== 'WIFI' && tipo !== 'ASESORIA') unitario *= 0.90;
                return unitario;
            }, [config]);

            // --- HELPERS ---
            const getEquipoActual = () => equipos.find(e => e.id === equipoSeleccionadoId) || { nombre: 'Desconocido', cuenta: [] };
            const calcularTiempo = (eq) => {
                if (!eq || eq.estado === 'libre') return 0;
                let t = eq.tiempoAcumulado;
                if (eq.estado === 'ocupado' && eq.inicio) t += (Date.now() - eq.inicio);
                return t;
            };

            // --- CALCULO DE RENTA CON MINIMO ---
            const calcularTotalRenta = (eq) => {
                if (!eq || eq.tipo === 'DIRECTA') return 0;
                if (eq.modo === 'prepago') return 0; // El prepago ya se cobrÃ³ al inicio
                const tiempoMs = eq.estado === 'finalizado' ? eq.tiempoAcumulado : calcularTiempo(eq);
                const horas = tiempoMs / 3600000;
                const tarifa = parseFloat(eq.precioHora);
                let total = horas * tarifa;
                
                // Aplicar tarifa mÃ­nima si hay uso significativo (mÃ¡s de 1 min) pero costo menor al mÃ­nimo
                if (tiempoMs > 60000 && total < config.tarifaMinima) {
                    return Math.round(config.tarifaMinima);
                }
                
                return Math.round(Math.max(total, 0));
            };

            // --- HELPER: VERIFICAR CAJA ---
            const verificarCaja = () => {
                if (!caja.activa) {
                    playSound('warning');
                    addToast("âš ï¸ DEBES INICIAR TURNO EN CAJA PRIMERO\nAntes de realizar cualquier operaciÃ³n, ingresa el fondo inicial.", 'warning');
                    setModalAbierto('caja');
                    return false;
                }
                return true;
            };

            // --- GESTIÃ“N CAJA ---
            const abrirCaja = () => {
                if (!cajaForm.fondo) return addToast("Ingresa un fondo inicial", 'warning');
                setCaja({ activa: true, fondo: parseFloat(cajaForm.fondo), inicio: new Date().toISOString() });
                setCajaForm({ fondo: '' });
                addToast("Turno iniciado correctamente.", 'success');
            };

            const cerrarCaja = () => {
                if(confirm("Â¿Seguro que deseas cerrar el turno y hacer corte? Se generarÃ¡ el reporte PDF.")) {
                    const ventasTurno = obtenerVentasTurno();
                    const totalVentas = ventasTurno.reduce((acc, v) => acc + (v.cancelada ? 0 : v.total), 0);
                    
                    const nuevoCorte = {
                        id: Date.now(),
                        fecha: new Date().toISOString(),
                        inicio: caja.inicio,
                        fondo: caja.fondo,
                        totalVentas: totalVentas,
                        totalCaja: caja.fondo + totalVentas,
                        usuario: usuarioActual.nombre,
                        ventasSnapshot: ventasTurno // Guardamos snapshot para reimpresiÃ³n exacta
                    };
                    
                    setCortes(prev => [nuevoCorte, ...prev]);
                    generarReporteCaja(caja, ventasTurno); // Generar PDF Carta
                    
                    setCaja({ activa: false, fondo: 0, inicio: null });
                    addToast("Turno cerrado. Reporte generado.", 'success');
                    setModalAbierto(null);
                }
            };

            const obtenerVentasTurno = () => {
                if (!caja.inicio) return [];
                return ventas.filter(v => new Date(v.fecha) >= new Date(caja.inicio));
            };
            
            const cancelarVenta = (id) => {
                if (usuarioActual.rol !== 'admin') return addToast("Acceso denegado. Solo administradores.", 'error');
                const venta = ventas.find(v => v.id === id);
                if (!venta) return;
                if (venta.cancelada) return addToast("Esta venta ya estÃ¡ cancelada.", 'warning');
                
                // Validar que sea del mismo dÃ­a
                const hoy = new Date().toDateString();
                const fechaVenta = new Date(venta.fecha).toDateString();
                if (hoy !== fechaVenta) return addToast("Solo se pueden cancelar ventas del dÃ­a actual.", 'warning');
                
                if (confirm(`Â¿Cancelar venta Folio ${venta.id.toString().slice(-4)} de $${venta.total.toFixed(2)}?\nSe devolverÃ¡ el stock y los puntos.`)) {
                    // 1. Devolver Stock
                    const nCat = [...catalogo];
                    (venta.productos || []).forEach(p => {
                        if (p.idCatalogo) {
                            const idx = nCat.findIndex(c => c.id === p.idCatalogo);
                            if (idx !== -1) nCat[idx].stock += (p.cantidad || 1);
                        }
                    });
                    setCatalogo(nCat);
                    
                    // 2. Retirar Puntos (si aplica)
                    if (venta.puntosGanados > 0) {
                        const clienteNombre = venta.cliente;
                        setClientes(prev => prev.map(c => {
                            if (c.nombre === clienteNombre) {
                                return { ...c, puntos: Math.max(0, (c.puntos || 0) - venta.puntosGanados) };
                            }
                            return c;
                        }));
                    }
                    
                    // 3. Marcar cancelada
                    setVentas(prev => prev.map(v => v.id === id ? { ...v, cancelada: true } : v));
                    addToast("Venta cancelada correctamente.", 'success');
                }
            };
            
            const reimprimirCorte = (corte) => {
                // Reconstruir objeto caja simulado para el reporte
                const cajaSimulada = { fondo: corte.fondo, inicio: corte.inicio };
                generarReporteCaja(cajaSimulada, corte.ventasSnapshot || []);
            };

            // --- GESTIÃ“N ESTACIONES (CRUD) ---
            const guardarEstacion = () => {
                if (!estacionForm.nombre || !estacionForm.precioHora) return addToast("Faltan datos", 'warning');
                const nueva = {
                    id: estacionForm.id || Date.now(),
                    nombre: estacionForm.nombre,
                    tipo: estacionForm.tipo,
                    precioHora: parseFloat(estacionForm.precioHora),
                    estado: 'libre', inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false
                };
                if (estacionForm.id) {
                    setEquipos(prev => prev.map(e => e.id === estacionForm.id ? { ...e, nombre: estacionForm.nombre, tipo: estacionForm.tipo, precioHora: parseFloat(estacionForm.precioHora) } : e));
                } else {
                    setEquipos(prev => [...prev, nueva]);
                }
                setEstacionForm({ id: null, nombre: '', tipo: 'PC', precioHora: '' });
            };

            const eliminarEstacion = (id) => {
                if(confirm("Â¿Eliminar estaciÃ³n? Se perderÃ¡n los datos actuales.")) setEquipos(prev => prev.filter(e => e.id !== id));
            };

            const prepararEdicionEstacion = (est) => setEstacionForm(est);

            // --- GESTIÃ“N INVENTARIO ---
            const guardarProductoInventario = () => {
                if (!itemForm.nombre || !itemForm.precio) return addToast("Faltan datos", 'warning');
                const nuevo = { ...itemForm, id: itemForm.id || Date.now(), precio: parseFloat(itemForm.precio), stock: parseInt(itemForm.stock) || 0, icon: itemForm.categoria === 'Bebidas' ? 'ðŸ¥¤' : 'ðŸ“¦' };
                if (itemForm.id) setCatalogo(prev => prev.map(p => p.id === itemForm.id ? { ...p, ...nuevo } : p));
                else setCatalogo(prev => [...prev, nuevo]);
                setItemForm({ id: null, nombre: '', precio: '', stock: '', categoria: 'General', codigo: '' });
                if(showCamera) playSound('success');
            };
            const eliminarProductoInventario = (id) => { if(confirm("Â¿Eliminar?")) setCatalogo(prev => prev.filter(p => p.id !== id)); };
            const prepararEdicionProducto = (prod) => setItemForm(prod);
            
			// --- HELPER: NUMERO A LETRAS ---
        const numeroALetras = (amount) => {
            const Unidades = num => ["", "UN ", "DOS ", "TRES ", "CUATRO ", "CINCO ", "SEIS ", "SIETE ", "OCHO ", "NUEVE "][num];
            const Decenas = num => {
                const dec = Math.floor(num / 10);
                const uni = num - (dec * 10);
                switch (dec) {
                    case 1: return uni < 6 ? ["DIEZ ", "ONCE ", "DOCE ", "TRECE ", "CATORCE ", "QUINCE "][uni] : "DIECI" + Unidades(uni);
                    case 2: return uni === 0 ? "VEINTE " : "VEINTI" + Unidades(uni);
                    case 3: return Unidades(uni) ? "TREINTA Y " + Unidades(uni) : "TREINTA ";
                    case 4: return Unidades(uni) ? "CUARENTA Y " + Unidades(uni) : "CUARENTA ";
                    case 5: return Unidades(uni) ? "CINCUENTA Y " + Unidades(uni) : "CINCUENTA ";
                    case 6: return Unidades(uni) ? "SESENTA Y " + Unidades(uni) : "SESENTA ";
                    case 7: return Unidades(uni) ? "SETENTA Y " + Unidades(uni) : "SETENTA ";
                    case 8: return Unidades(uni) ? "OCHENTA Y " + Unidades(uni) : "OCHENTA ";
                    case 9: return Unidades(uni) ? "NOVENTA Y " + Unidades(uni) : "NOVENTA ";
                    case 0: return Unidades(uni);
                }
            };
            const Centenas = num => {
                const cen = Math.floor(num / 100);
                const resto = num - (cen * 100);
                if (cen === 1) return resto > 0 ? "CIENTO " + Decenas(resto) : "CIEN ";
                return ["", "CIENTO ", "DOSCIENTOS ", "TRESCIENTOS ", "CUATROCIENTOS ", "QUINIENTOS ", "SEISCIENTOS ", "SETECIENTOS ", "OCHOCIENTOS ", "NOVECIENTOS "][cen] + Decenas(resto);
            };

            const pesos = Math.floor(amount);
            const centavos = Math.round((amount - pesos) * 100);
            let letras = "";

            if (pesos === 0) letras = "CERO ";
            else if (pesos < 100) letras = Decenas(pesos);
            else if (pesos < 1000) letras = Centenas(pesos);
            else if (pesos < 2000) letras = "MIL " + Centenas(pesos % 1000);
            else if (pesos < 1000000) letras = Centenas(Math.floor(pesos / 1000)) + " MIL " + Centenas(pesos % 1000);

            return `${letras.trim()} PESOS ${centavos.toString().padStart(2, '0')}/100 M.N.`;
        };

            // --- LOGICA VENTA DIRECTA (MOSTRADOR) ---
            const abrirVentaDirecta = () => {
                if (!verificarCaja()) return;
                setCarritoDirecto([]);
                setServicioForm({ tipo: 'IMPRESION_BN', tamano: 'CARTA', cobertura: 'B', cantidad: 1 });
                setVentaDirectaClienteId(1); 
                setMostrarNuevoCliente(false);
                setPagoConDirecto(''); // Reset pagoCon
                setBusquedaDirecta('');
                setModalAbierto('venta_directa');
            };

            const agregarProductoDirecto = (prod) => {
                setCarritoDirecto(prev => {
                    const idx = prev.findIndex(p => p.idCatalogo === prod.id);
                    if (idx !== -1) {
                        const copia = [...prev];
                        copia[idx] = { ...copia[idx], cantidad: (copia[idx].cantidad || 1) + 1 };
                        return copia;
                    }
                    return [...prev, { uid: Date.now(), idCatalogo: prod.id, nombre: prod.nombre, precio: parseFloat(prod.precio), cantidad: 1 }];
                });
                playSound('scan');
            };

            const agregarServicioDirecto = () => {
                 const { tipo, tamano, cobertura, cantidad } = servicioForm;
                const precioUnitario = calcularPrecio(tipo, tamano, cobertura, 1); // Precio base unitario sin descuento cantidad para mostrar
                let nombreServicio = '';
                if (tipo === 'ENVIO') nombreServicio = `EnvÃ­o Digital`;
                else if (tipo === 'ESCANEO') nombreServicio = `Escaneo ${tamano}`;
                else if (tipo === 'WIFI') nombreServicio = 'Acceso WiFi (Dispositivo)';
                else if (tipo === 'ASESORIA') nombreServicio = 'AsesorÃ­a / Apoyo TÃ©cnico';
                else nombreServicio = `${tipo === 'IMPRESION_BN' ? 'Imp. B/N' : 'Imp. Color'} ${tamano} (${cobertura})`;
                
                // El precio final con descuento se calcula al insertar o se guarda el unitario y se aplica lÃ³gica. 
                // Para consistencia con el sistema actual, guardamos el precio unitario FINAL (con descuento si aplica)
                const precioFinal = calcularPrecio(tipo, tamano, cobertura, cantidad);
                
                const nombreFinal = nombreServicio + (cantidad > 10 ? ' (-10%)' : '');
                
                setCarritoDirecto(prev => {
                    const idx = prev.findIndex(p => p.nombre === nombreFinal && p.precio === parseFloat(precioFinal));
                    if (idx !== -1) {
                        const copia = [...prev];
                        copia[idx] = { ...copia[idx], cantidad: (copia[idx].cantidad || 1) + (parseInt(cantidad) || 1) };
                        return copia;
                    }
                    return [...prev, { uid: Date.now(), idCatalogo: null, nombre: nombreFinal, precio: parseFloat(precioFinal), cantidad: parseInt(cantidad) || 1 }];
                });
                setServicioForm({ ...servicioForm, cantidad: 1 });
                playSound('success');
            };

            const agregarManualDirecto = () => {
                if(!manualItemForm.nombre || !manualItemForm.precio) return;
                const nombreFinal = manualItemForm.nombre + ' (Manual)';
                const precioFinal = parseFloat(manualItemForm.precio);
                setCarritoDirecto(prev => {
                    const idx = prev.findIndex(p => p.nombre === nombreFinal && p.precio === precioFinal);
                    if (idx !== -1) {
                        const copia = [...prev];
                        copia[idx] = { ...copia[idx], cantidad: (copia[idx].cantidad || 1) + 1 };
                        return copia;
                    }
                    return [...prev, { uid: Date.now(), idCatalogo: null, nombre: nombreFinal, precio: precioFinal, cantidad: 1, esManual: true }];
                });
                setManualItemForm({nombre: '', precio: ''});
                playSound('success');
            };

            const agregarClienteRapido = () => {
                if(!nuevoClienteNombre.trim()) return addToast("Nombre vacÃ­o", 'warning');
                const nuevo = { id: Date.now(), nombre: nuevoClienteNombre, puntos: 0 };
                setClientes(prev => [...prev, nuevo]);
                setVentaDirectaClienteId(nuevo.id);
                setNuevoClienteNombre('');
                setMostrarNuevoCliente(false);
                addToast("Cliente registrado y seleccionado.", 'success');
            };

            const eliminarItemDirecto = (uid) => {
                setCarritoDirecto(prev => prev.filter(i => i.uid !== uid));
            };

            const disminuirCantidadDirecto = (uid) => {
                setCarritoDirecto(prev => prev.map(i => {
                    if (i.uid === uid) {
                        return { ...i, cantidad: (i.cantidad || 1) - 1 };
                    }
                    return i;
                }).filter(i => i.cantidad > 0));
            };

            const cobrarVentaDirecta = async () => {
                if (carritoDirecto.length === 0) return addToast("El carrito estÃ¡ vacÃ­o.", 'warning');
                
                setProcesando(true);
                await new Promise(resolve => setTimeout(resolve, 600));
                
                const total = carritoDirecto.reduce((a, i) => a + (i.precio * (i.cantidad || 1)), 0);
                const pagoCon = parseFloat(pagoConDirecto) || 0;
                const cambio = pagoCon - total;

                const cliente = clientes.find(c => c.id === parseInt(ventaDirectaClienteId)) || { id: 1, nombre: 'PÃºblico General', puntos: 0 };
                let puntosGanados = 0;
                
                if (cliente.id !== 1) { 
                    puntosGanados = Math.floor(total * RATIO_PUNTOS);
                    setClientes(prev => prev.map(c => c.id === cliente.id ? { ...c, puntos: (c.puntos || 0) + puntosGanados } : c));
                    if(puntosGanados > 0) addToast(`ðŸŽ‰ Â¡${cliente.nombre} ganÃ³ ${puntosGanados} Puntos!`, 'success');
                }
                
                const nCat = [...catalogo];
                carritoDirecto.forEach(i => { if (i.idCatalogo) { const idx = nCat.findIndex(p => p.id === i.idCatalogo); if (idx !== -1) nCat[idx].stock = Math.max(0, nCat[idx].stock - 1); } });
                setCatalogo(nCat);

                const venta = { 
                    id: Date.now(), 
                    fecha: new Date().toISOString(), 
                    equipo: "Mostrador", 
                    cliente: cliente.nombre, 
                    total, 
                    puntosGanados, 
                    productos: carritoDirecto, 
                    subtotalRenta: 0,
                    pagoCon: pagoCon, 
                    cambio: cambio,
                    atendio: usuarioActual.nombre,
                    cancelada: false
                };
                
                setVentas(prev => [...prev, venta]);
                generarTicket(venta, config.formatoTicket || '58mm'); // Usar formato configurado
                playSound('success');
                setModalAbierto(null);
                setCarritoDirecto([]);
                setPagoConDirecto('');
                setProcesando(false);
            };

            // --- FUNCIONES EXPORTAR / IMPORTAR ---
            const handleExport = () => {
                const data = {
                    equipos, ventas, catalogo, clientes, usuarios, config, caja, cortes
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sysquantic_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                addToast("âœ… Respaldo descargado correctamente. Guarde este archivo en un lugar seguro.", 'success');
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (Array.isArray(data.equipos) && Array.isArray(data.catalogo) && Array.isArray(data.clientes)) {
                            if(confirm("âš ï¸ ADVERTENCIA: Esto borrarÃ¡ los datos actuales y cargarÃ¡ el respaldo. Â¿Continuar?")) {
                                localStorage.setItem('sys-equipos', JSON.stringify(data.equipos));
                                localStorage.setItem('sys-ventas', JSON.stringify(data.ventas || []));
                                localStorage.setItem('sys-catalogo', JSON.stringify(data.catalogo));
                                localStorage.setItem('sys-clientes', JSON.stringify(data.clientes));
                                if(data.usuarios) localStorage.setItem('sys-usuarios', JSON.stringify(data.usuarios));
                                if(data.config) localStorage.setItem('sys-config', JSON.stringify(data.config));
                                if(data.caja) localStorage.setItem('sys-caja', JSON.stringify(data.caja));
                                if(data.cortes) localStorage.setItem('sys-cortes', JSON.stringify(data.cortes));
                                
                                addToast("âœ… Datos importados correctamente. El sistema se reiniciarÃ¡ para aplicar cambios.", 'success');
                                setTimeout(() => window.location.reload(), 2000);
                            }
                        } else {
                            addToast("âŒ Error: El archivo no tiene el formato vÃ¡lido de SysQuantic.", 'error');
                        }
                    } catch (err) {
                        addToast("âŒ Error al leer el archivo: " + err, 'error');
                    }
                };
                reader.readAsText(file);
            };

            // --- SERVICIOS ESTACIONES ---
            const agregarProductoACuenta = (prod) => {
                 setEquipos(prev => prev.map(eq => {
                    if (eq.id === equipoSeleccionadoId) {
                        const idx = eq.cuenta.findIndex(p => p.idCatalogo === prod.id);
                        if (idx !== -1) {
                            const nc = [...eq.cuenta];
                            nc[idx] = { ...nc[idx], cantidad: (nc[idx].cantidad || 1) + 1 };
                            return { ...eq, cuenta: nc };
                        }
                        return { ...eq, cuenta: [...eq.cuenta, { uid: Date.now(), idCatalogo: prod.id, nombre: prod.nombre, precio: parseFloat(prod.precio), cantidad: 1 }] };
                    }
                    return eq;
                 }));
            };
            
            const agregarManualACuenta = () => {
                if(!manualItemForm.nombre || !manualItemForm.precio) return;
                const nombreFinal = manualItemForm.nombre + ' (Manual)';
                const precioFinal = parseFloat(manualItemForm.precio);
                setEquipos(prev => prev.map(eq => {
                    if (eq.id === equipoSeleccionadoId) {
                        const idx = eq.cuenta.findIndex(p => p.nombre === nombreFinal && p.precio === precioFinal);
                        if (idx !== -1) {
                            const nc = [...eq.cuenta];
                            nc[idx] = { ...nc[idx], cantidad: (nc[idx].cantidad || 1) + 1 };
                            return { ...eq, cuenta: nc };
                        }
                        return { ...eq, cuenta: [...eq.cuenta, { uid: Date.now(), idCatalogo: null, nombre: nombreFinal, precio: precioFinal, cantidad: 1, esManual: true }] };
                    }
                    return eq;
                }));
                setManualItemForm({nombre: '', precio: ''});
                playSound('success');
            };

            const agregarServicioACuenta = () => {
                const { tipo, tamano, cobertura, cantidad } = servicioForm;
                const precioFinal = calcularPrecio(tipo, tamano, cobertura, cantidad);
                let nombreServicio = '';
                if (tipo === 'ENVIO') nombreServicio = `EnvÃ­o Digital`;
                else if (tipo === 'ESCANEO') nombreServicio = `Escaneo ${tamano}`;
                else if (tipo === 'WIFI') nombreServicio = 'Acceso WiFi (Dispositivo)';
                else if (tipo === 'ASESORIA') nombreServicio = 'AsesorÃ­a / Apoyo TÃ©cnico';
                else nombreServicio = `${tipo === 'IMPRESION_BN' ? 'Imp. B/N' : 'Imp. Color'} ${tamano} (${cobertura})`;

                const nombreFinal = nombreServicio + (cantidad > 10 ? ' (-10%)' : '');

                setEquipos(prev => prev.map(eq => {
                    if (eq.id === equipoSeleccionadoId) {
                        const idx = eq.cuenta.findIndex(p => p.nombre === nombreFinal && p.precio === parseFloat(precioFinal));
                        if (idx !== -1) {
                            const nc = [...eq.cuenta];
                            nc[idx] = { ...nc[idx], cantidad: (nc[idx].cantidad || 1) + (parseInt(cantidad) || 1) };
                            return { ...eq, cuenta: nc };
                        }
                        return { ...eq, cuenta: [...eq.cuenta, { uid: Date.now(), idCatalogo: null, nombre: nombreFinal, precio: parseFloat(precioFinal), cantidad: parseInt(cantidad) || 1 }] };
                    }
                    return eq;
                }));
                setServicioForm({ ...servicioForm, cantidad: 1 });
            };
            const eliminarProductoDeCuenta = (uid) => { setEquipos(prev => prev.map(e => e.id === equipoSeleccionadoId ? { ...e, cuenta: e.cuenta.filter(i => i.uid !== uid) } : e)); };
            
            const disminuirCantidadDeCuenta = (uid) => {
                 setEquipos(prev => prev.map(eq => {
                    if (eq.id === equipoSeleccionadoId) {
                        return { ...eq, cuenta: eq.cuenta.map(i => {
                            if (i.uid === uid) return { ...i, cantidad: (i.cantidad || 1) - 1 };
                            return i;
                        }).filter(i => i.cantidad > 0) };
                    }
                    return eq;
                 }));
            };

            // --- ACCIONES ---
            const iniciarTiempoLibre = (id) => { 
                if (!verificarCaja()) return;
                setEquipos(prev => prev.map(eq => eq.id === id ? { ...eq, estado: 'ocupado', inicio: Date.now(), modo: 'libre', limiteTiempo: 0, alertaMinuto: false } : eq)); 
            };
            const togglePausa = (id) => {
                if (!verificarCaja()) return;
                setEquipos(prev => prev.map(eq => {
                    if (eq.id === id) {
                        if (eq.estado === 'ocupado') return { ...eq, estado: 'pausado', tiempoAcumulado: eq.tiempoAcumulado + (Date.now() - eq.inicio), inicio: null };
                        if (eq.estado === 'pausado') return { ...eq, estado: 'ocupado', inicio: Date.now() };
                    }
                    return eq;
                }));
            };
            const abrirPrepago = (id) => { 
                if (!verificarCaja()) return;
                setEquipoSeleccionadoId(id); setPrepagoData({ dinero: '', minutos: '' }); setModalAbierto('prepago'); 
            };
            
            const aplicarPrepago = () => {
                const eq = getEquipoActual();
                let ms = 0;
                let totalCobrado = 0;

                if (prepagoData.dinero) {
                    totalCobrado = parseFloat(prepagoData.dinero);
                    ms = (totalCobrado / eq.precioHora) * 3600000;
                } else if (prepagoData.minutos) {
                    const mins = parseInt(prepagoData.minutos);
                    ms = mins * 60000;
                    totalCobrado = (mins / 60) * eq.precioHora;
                }

                if (ms > 0) { 
                    setEquipos(prev => prev.map(e => e.id === eq.id ? { ...e, estado: 'ocupado', inicio: Date.now(), modo: 'prepago', limiteTiempo: ms, tiempoAcumulado: 0, alertaMinuto: false } : e)); 
                    
                    // Generar Ticket y Venta de inmediato (Cobro Anticipado)
                    const venta = { 
                        id: Date.now(), 
                        fecha: new Date().toISOString(), 
                        equipo: eq.nombre, 
                        cliente: "Cliente General", 
                        total: totalCobrado, 
                        puntosGanados: 0, 
                        productos: [{ nombre: `Renta Prepago (${(ms/60000).toFixed(0)} min)`, precio: totalCobrado, cantidad: 1 }], 
                        subtotalRenta: 0, // Se pone en productos para descripciÃ³n clara
                        pagoCon: totalCobrado, 
                        cambio: 0,
                        atendio: usuarioActual.nombre,
                        cancelada: false
                    };
                    setVentas(prev => [...prev, venta]);
                    generarTicket(venta, config.formatoTicket || '58mm');
                    playSound('success');
                    setModalAbierto(null); 
                } 
                else addToast("Datos invÃ¡lidos", 'error');
            };
            
            // --- CANCELAR SERVICIO (MODAL) ---
            const cancelarServicio = (id) => {
                if (!verificarCaja()) return;
                setConfirmarResetId(id);
            };

            const ejecutarReset = () => {
                if (confirmarResetId) {
                    setEquipos(prev => prev.map(e => e.id === confirmarResetId ? { ...e, estado: 'libre', inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false } : e));
                    setConfirmarResetId(null);
                    playSound('warning');
                }
            };

            // --- USUARIOS ---
            const guardarUsuario = () => {
                if(!usuarioForm.nombre || !usuarioForm.pin) return addToast("Faltan datos", 'warning');
                setUsuarios(prev => [...prev, { ...usuarioForm, id: Date.now() }]);
                setUsuarioForm({ nombre: '', pin: '', rol: 'empleado' });
            };
            const eliminarUsuario = (id) => { if(id !== 1 && confirm("Â¿Eliminar?")) setUsuarios(prev => prev.filter(u => u.id !== id)); };
            const actualizarPin = () => {
                if (pinData.nuevo.length !== 4 || pinData.nuevo !== pinData.confirmar) return addToast("Error en PIN", 'error');
                setUsuarios(prev => prev.map(u => u.id === usuarioActual.id ? { ...u, pin: pinData.nuevo } : u));
                setUsuarioActual(prev => ({ ...prev, pin: pinData.nuevo }));
                addToast("Actualizado", 'success'); setModalAbierto(null); setPinData({ nuevo: '', confirmar: '' });
            };

            // --- INTERCAMBIO ---
            const iniciarIntercambio = (id) => { 
                if (!verificarCaja()) return;
                setEquipoSeleccionadoId(id); setModalAbierto('intercambio'); 
            };
            const confirmarIntercambio = (idDestino) => {
                setEquipos(prev => {
                    const origen = prev.find(e => e.id === equipoSeleccionadoId);
                    const destino = prev.find(e => e.id === idDestino);
                    if(!origen || !destino) return prev;
                    let tiempo = origen.tiempoAcumulado + ((origen.estado === 'ocupado' && origen.inicio) ? (Date.now() - origen.inicio) : 0);
                    const nuevoDestino = { ...destino, estado: origen.estado === 'pausado'?'pausado':'ocupado', inicio: origen.estado === 'pausado'?null:Date.now(), tiempoAcumulado: tiempo, cuenta: [...origen.cuenta], modo: origen.modo, limiteTiempo: origen.limiteTiempo, alertaMinuto: origen.alertaMinuto };
                    const nuevoOrigen = { ...origen, estado: 'libre', inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false };
                    return prev.map(e => e.id === origen.id ? nuevoOrigen : e.id === destino.id ? nuevoDestino : e);
                });
                setModalAbierto(null);
            };

            // --- COBRO ---
            const procesarCobro = async () => {
                setProcesando(true);
                await new Promise(resolve => setTimeout(resolve, 600));

                const eq = getEquipoActual();
                const subRenta = calcularTotalRenta(eq);
                const subProd = eq.cuenta.reduce((a, i) => a + (i.precio * (i.cantidad || 1)), 0); 
                const total = subRenta + subProd;
                
                // CÃ¡lculo de cambio en EstaciÃ³n
                const pagoCon = parseFloat(checkoutData.pagoCon) || 0;
                const cambio = pagoCon - total;

                const cliente = clientes.find(c => c.id === checkoutData.clienteId) || { id: 1, nombre: 'General', puntos: 0 };
                let puntosGanados = 0;
                if (cliente.id !== 1) { 
                    puntosGanados = Math.floor(total * RATIO_PUNTOS);
                    setClientes(prev => prev.map(c => c.id === cliente.id ? { ...c, puntos: (c.puntos || 0) + puntosGanados } : c));
                    if(puntosGanados > 0) addToast(`ðŸŽ‰ Â¡${cliente.nombre} ganÃ³ ${puntosGanados} Puntos!`, 'success');
                }
                const nCat = [...catalogo];
                eq.cuenta.forEach(i => { if (i.idCatalogo) { const idx = nCat.findIndex(p => p.id === i.idCatalogo); if (idx !== -1) nCat[idx].stock = Math.max(0, nCat[idx].stock - 1); } });
                setCatalogo(nCat);
                const venta = { 
                    id: Date.now(), 
                    fecha: new Date().toISOString(), 
                    equipo: eq.nombre, 
                    cliente: cliente.nombre, 
                    total, 
                    puntosGanados, 
                    productos: eq.cuenta, 
                    subtotalRenta: subRenta,
                    pagoCon: pagoCon, 
                    cambio: cambio,
                    atendio: usuarioActual.nombre,
                    cancelada: false
                };
                setVentas(prev => [...prev, venta]);
                setEquipos(prev => prev.map(e => e.id === eq.id ? { ...e, estado: 'libre', inicio: null, tiempoAcumulado: 0, cuenta: [], modo: 'libre', limiteTiempo: 0, alertaMinuto: false } : e));
                setModalAbierto(null);
                setCheckoutData({ clienteId: 1, pagoCon: '' }); // Reset
                generarTicket(venta, config.formatoTicket || '58mm'); // Usar formato configurado
                playSound('success');
                setProcesando(false);
            };

            // --- REPORTES Y TICKETS (LÃ“GICA ACTUALIZADA FISCAL) ---
            const generarTicket = (venta, formato = '58mm') => {
                if (!window.jspdf) return addToast("Error PDF", 'error');
                try {
                    const { jsPDF } = window.jspdf;
                    
                    // Agrupar productos visualmente para el ticket
                    const productosAgrupados = [];
                    (venta.productos || []).forEach(p => {
                        const existing = productosAgrupados.find(i => i.nombre === p.nombre && i.precio === p.precio);
                        if (existing) {
                            existing.cantidad = (existing.cantidad || 1) + (p.cantidad || 1);
                        } else {
                            productosAgrupados.push({ ...p, cantidad: p.cantidad || 1 });
                        }
                    });

                    const negocio = config.negocio || CONFIG_INICIAL.negocio;
                    const tConfig = config.ticketConfig || CONFIG_INICIAL.ticketConfig;
                    const sepChar = tConfig.separador || '-';
                    const separator = sepChar.repeat(40);
                    
                    // CÃ¡lculos Fiscales (Desglosar IVA del Total)
                    // Total = Base * 1.16  =>  Base = Total / 1.16
                    const total = venta.total;
                    const subtotalBase = total / 1.16;
                    const iva = total - subtotalBase;
                    const totalLetras = numeroALetras(total);

                    // Formato de Fecha dd-mm-aaaa
                    const dateObj = new Date(venta.fecha);
                    const dia = String(dateObj.getDate()).padStart(2, '0');
                    const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const anio = dateObj.getFullYear();
                    const fechaFormat = `${dia}-${mes}-${anio}`;
                    const horaFormat = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    // Folio Simulado UT-XXX (Usando los Ãºltimos digitos del ID para simular secuencia)
                    const folioFiscal = `UT-${String(venta.id).slice(-4)}`;

                    if (formato === 'LETTER') {
                        // --- FORMATO CARTA (Formal) ---
                        const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "letter" });
                        
                        // Encabezado Fiscal
                        doc.setFontSize(14);
                        doc.setFont("helvetica", "bold");
                        doc.text(negocio.nombre, 105, 20, { align: 'center' });
                        
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "normal");
                        doc.text(`RFC: ${negocio.rfc}`, 105, 26, { align: 'center' });
                        doc.text(negocio.regimen, 105, 31, { align: 'center' });
                        doc.text(`Lugar de ExpediciÃ³n: ${negocio.lugarExpedicion}`, 105, 36, { align: 'center' });

                        // Datos de la OperaciÃ³n
                        doc.setDrawColor(200);
                        doc.line(10, 42, 206, 42);
                        
                        doc.setFont("helvetica", "bold");
                        doc.text(`Folio: ${folioFiscal}`, 20, 50);
                        doc.setFont("helvetica", "normal");
                        doc.text(`Fecha de ExpediciÃ³n: ${fechaFormat}`, 120, 50);
                        doc.text(`Cliente: ${venta.cliente}`, 20, 56);

                        // Tabla de Productos
                        const tableData = [];
                        
                        // Agregar Renta si existe
                        if(venta.subtotalRenta > 0) {
                            tableData.push([
                                '1', 
                                'Renta de Equipo de CÃ³mputo/Consola', 
                                `$${venta.subtotalRenta.toFixed(2)}`, 
                                `$${venta.subtotalRenta.toFixed(2)}`
                            ]);
                        }
                        
                        // Agregar Productos
                        productosAgrupados.forEach(p => {
                            const cantidad = p.cantidad || 1;
                            const importe = cantidad * p.precio;
                            tableData.push([
                                cantidad, 
                                p.nombre, 
                                `$${p.precio.toFixed(2)}`, 
                                `$${importe.toFixed(2)}`
                            ]);
                        });

                        doc.autoTable({
                            startY: 65,
                            head: [[tConfig.headers.cant, tConfig.headers.desc, tConfig.headers.pu, tConfig.headers.importe]],
                            body: tableData,
                            theme: 'plain',
                            styles: { fontSize: 10, cellPadding: 2 },
                            headStyles: { fillColor: [240, 240, 240], textColor: 20, fontStyle: 'bold', halign: 'center' },
                            columnStyles: {
                                0: { halign: 'center' }, // Cant
                                2: { halign: 'right' },  // PU
                                3: { halign: 'right' }   // Importe
                            }
                        });

                        const finalY = doc.lastAutoTable.finalY + 10;

                        // Totales y Desglose
                        doc.setFontSize(10);
                        // Total con letra
                        doc.text(`IMPORTE CON LETRA:`, 20, finalY);
                        doc.setFont("helvetica", "bold");
                        doc.text(totalLetras, 20, finalY + 5);

                        // Desglose NumÃ©rico (Alineado a la derecha)
                        const xValores = 190;
                        const xEtiquetas = 150;

                        doc.setFont("helvetica", "normal");
                        doc.text("Subtotal:", xEtiquetas, finalY, { align: 'right' });
                        doc.text(`$${subtotalBase.toFixed(2)}`, xValores, finalY, { align: 'right' });

                        doc.text("IVA (16%):", xEtiquetas, finalY + 6, { align: 'right' });
                        doc.text(`$${iva.toFixed(2)}`, xValores, finalY + 6, { align: 'right' });

                        doc.setFontSize(12);
                        doc.setFont("helvetica", "bold");
                        doc.text("TOTAL:", xEtiquetas, finalY + 14, { align: 'right' });
                        doc.text(`$${total.toFixed(2)}`, xValores, finalY + 14, { align: 'right' });

                        // Pie de pÃ¡gina
                        doc.setFontSize(8);
                        doc.setFont("helvetica", "italic");
                        doc.text("Este documento es una representaciÃ³n impresa de una venta.", 105, 260, { align: 'center' });

                        doc.save(`Factura_${folioFiscal}.pdf`);

                    } else {
                        // --- FORMATO 58MM (TÃ‰RMICO) ---
                        // Calculamos largo dinÃ¡mico
                        const linesHeight = 120 + (productosAgrupados.length * 10);
                        const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: [58, linesHeight] });
                        
                        let y = 5;
                        const centerX = 29;
                        const margin = 2;
                        const rightX = 56;

                        // Encabezado
                        doc.setFont("helvetica", "bold"); 
                        doc.setFontSize(9);
                        doc.text(negocio.nombre, centerX, y, { align: 'center', maxWidth: 54 }); 
                        // Ajuste manual de salto de lÃ­nea si el nombre es largo
                        y += (doc.getTextDimensions(negocio.nombre).h) + 3;

                        doc.setFont("helvetica", "normal");
                        doc.setFontSize(7);
                        doc.text(`RFC: ${negocio.rfc}`, centerX, y, { align: 'center' }); y+=4;
                        doc.text(negocio.regimen, centerX, y, { align: 'center', maxWidth: 54 }); 
                        y += (doc.getTextDimensions(negocio.regimen).h) + 1; // Salto dinÃ¡mico
                        
                        // Espacio solicitado
                        y += 2;

                        doc.text(`Lugar de ExpediciÃ³n: ${negocio.lugarExpedicion}`, margin, y, { maxWidth: 54 });
                        y += (doc.getTextDimensions(`Lugar de ExpediciÃ³n: ${negocio.lugarExpedicion}`).h) + 3;

                        doc.text(`Fecha de ExpediciÃ³n: ${fechaFormat}`, margin, y); y+=4;
                        
                        doc.setFont("helvetica", "bold");
                        doc.text(`Folio: ${folioFiscal}`, rightX, y, { align: 'right' }); y+=4;
                        doc.setFont("helvetica", "normal");

                        doc.text(separator, margin, y); y+=4;
                        doc.text(`Cliente: ${venta.cliente.substring(0,25)}`, margin, y); y+=5;

                        // Encabezados Tabla
                        doc.setFont("helvetica", "bold");
                        // DistribuciÃ³n manual para 58mm: Cant(2), Desc(10), PU(42-Right), Imp(56-Right)
                        doc.text(tConfig.headers.cant, 2, y);
                        doc.text(tConfig.headers.desc, 10, y);
                        doc.text(tConfig.headers.pu, 42, y, { align: 'right' });
                        doc.text(tConfig.headers.importe, rightX, y, { align: 'right' });
                        y+=4;
                        doc.setFont("helvetica", "normal");
                        doc.text(separator, margin, y); y+=4;

                        // Items
                        // Renta
                        if(venta.subtotalRenta > 0) {
                            doc.text(`1`, 2, y);
                            doc.text(`Renta Equipo`, 10, y);
                            doc.text(`$${venta.subtotalRenta.toFixed(2)}`, 42, y, { align: 'right' });
                            doc.text(`$${venta.subtotalRenta.toFixed(2)}`, rightX, y, { align: 'right' });
                            y+=4;
                        }

                        // Productos
                        productosAgrupados.forEach(p => {
                            const qty = p.cantidad || 1;
                            const importe = qty * p.precio;
                            const nombre = p.nombre.substring(0, 14); // Truncar nombre para que quepa
                            doc.text(`${qty}`, 2, y);
                            doc.text(`${nombre}`, 10, y);
                            doc.text(`$${p.precio.toFixed(2)}`, 42, y, { align: 'right' });
                            doc.text(`$${importe.toFixed(2)}`, rightX, y, { align: 'right' });
                            y+=4;
                        });

                        doc.text(separator, margin, y); y+=4;

                        // Desglose Totales
                        doc.setFontSize(7);
                        doc.text("Subtotal:", 35, y, { align: 'right' });
                        doc.text(`$${subtotalBase.toFixed(2)}`, rightX, y, { align: 'right' }); y+=4;

                        doc.text("IVA (16%):", 35, y, { align: 'right' });
                        doc.text(`$${iva.toFixed(2)}`, rightX, y, { align: 'right' }); y+=5;

                        doc.setFontSize(10);
                        doc.setFont("helvetica", "bold");
                        doc.text("TOTAL:", 35, y, { align: 'right' });
                        doc.text(`$${total.toFixed(2)}`, rightX, y, { align: 'right' }); y+=6;

                        // Total en Letras
                        doc.setFontSize(6);
                        doc.setFont("helvetica", "italic");
                        // Dividir texto largo en lÃ­neas
                        const splitTitle = doc.splitTextToSize(totalLetras, 54);
                        doc.text(splitTitle, centerX, y, { align: 'center' });
                        y += (splitTitle.length * 3) + 4;

                        doc.setFontSize(7);
                        doc.setFont("helvetica", "normal");
                        doc.text(tConfig.mensajeFinal, centerX, y, { align: 'center' });

                        doc.save(`Ticket_${folioFiscal}.pdf`); 
                    }
                } catch(e) { console.error(e); addToast("Error generando PDF", 'error'); }
            };

            const generarReporteCaja = (cajaInfo, ventasList) => {
                if (!window.jspdf) return;
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "letter" });
                    
                    const totalVentas = ventasList.reduce((acc, v) => acc + (v.cancelada ? 0 : v.total), 0);
                    const totalCaja = cajaInfo.fondo + totalVentas;

                    // Encabezado
                    doc.setFontSize(22);
                    doc.setTextColor(40, 40, 40);
                    doc.setFont("helvetica", "bold");
                    doc.text("REPORTE DE CORTE DE CAJA", 105, 20, { align: 'center' });
                    
                    doc.setDrawColor(200, 200, 200);
                    doc.line(10, 25, 206, 25);

                    // InformaciÃ³n General
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont("helvetica", "normal");
                    
                    doc.text(`Fecha de Corte: ${new Date().toLocaleString()}`, 15, 35);
                    doc.text(`Inicio de Turno: ${new Date(cajaInfo.inicio).toLocaleString()}`, 15, 42);
                    
                    // Resumen Financiero
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, 50, 186, 30, 'F');
                    doc.setFont("helvetica", "bold");
                    
                    doc.text("Fondo Inicial:", 20, 60);
                    doc.text(`$${cajaInfo.fondo.toFixed(2)}`, 190, 60, { align: 'right' });
                    
                    doc.text("Total Ventas:", 20, 70);
                    doc.setTextColor(0, 100, 0);
                    doc.text(`+ $${totalVentas.toFixed(2)}`, 190, 70, { align: 'right' });
                    
                    doc.setDrawColor(100, 100, 100);
                    doc.line(20, 74, 190, 74);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(14);
                    doc.text("TOTAL EN CAJA:", 20, 82); // CORREGIDO (Antes decÃ­a "CAJA TOTAL:")
                    doc.text(`$${totalCaja.toFixed(2)}`, 190, 82, { align: 'right' });

                    // Detalle de Ventas
                    doc.setFontSize(14);
                    doc.text("Desglose de Movimientos", 15, 95);

                    const tableRows = ventasList.map(v => [
                        v.id.toString().slice(-6),
                        new Date(v.fecha).toLocaleTimeString(),
                        v.cliente.substring(0, 20),
                        v.equipo,
                        v.cancelada ? 'CANCELADA' : `$${v.total.toFixed(2)}`
                    ]);

                    doc.autoTable({
                        startY: 100,
                        head: [['Folio', 'Hora', 'Cliente', 'Origen', 'Monto']],
                        body: tableRows,
                        theme: 'striped',
                        headStyles: { fillColor: [44, 62, 80] },
                        styles: { fontSize: 10 }
                    });

                    // Footer
                    const finalY = doc.lastAutoTable.finalY + 20;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "italic");
                    doc.text("Firma de Conformidad", 105, finalY, { align: 'center' });
                    doc.line(70, finalY - 5, 140, finalY - 5);

                    doc.save(`CorteCaja_${new Date().toISOString().slice(0,10)}.pdf`);
                } catch(e) { console.error("Error PDF Corte", e); }
            };

            // --- RENDER ---
            if (!usuarioActual) return <LoginScreen onLogin={setUsuarioActual} usuarios={usuarios} empresa={config.negocio?.nombre || "FasTPV"} />;
            const eqSel = getEquipoActual();
            const ventasTurno = obtenerVentasTurno();
            const totalVentasTurno = ventasTurno.reduce((acc, v) => acc + (v.cancelada ? 0 : v.total), 0);

            return (
                <div className="min-h-screen bg-[#f2f2f7] text-slate-800 font-sans pb-10 selection:bg-blue-500 selection:text-white transition-colors duration-300">
                    {/* NAV */}
                    <nav className={`${COLOR_CORP} sticky top-0 z-20`}>
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-500 p-1.5 rounded-lg text-white shadow-lg shadow-blue-500/30"><Monitor size={20} /></div>
                                <div><h1 className="font-bold leading-tight hidden md:block">{config.negocio?.nombre || "FasTPV"}</h1><p className="text-[10px] text-slate-400">{SISTEMA}</p></div>
                            </div>
                            <div className="flex items-center gap-2">
                                {/* BOTON CORTE DE CAJA (NUEVO) */}
                                <button onClick={() => setModalAbierto('caja')} className={`px-3 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 shadow-sm border transition-all ${caja.activa ? 'bg-emerald-500/20 text-emerald-400 border-emerald-800 hover:bg-emerald-600 hover:text-white' : 'bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700 hover:text-slate-200'}`}>
                                    <Wallet size={18} /> <span className="hidden sm:inline">{caja.activa ? `$${(caja.fondo + totalVentasTurno).toFixed(2)}` : 'Caja'}</span>
                                </button>
                                
                                <div className="h-6 w-px bg-slate-700 mx-1"></div>

                                <button onClick={abrirVentaDirecta} className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 shadow-lg shadow-orange-500/30 transition-all fade-anim">
                                    <Store size={18} /> <span className="hidden sm:inline">Venta</span>
                                </button>
                                <button onClick={() => setModalAbierto('historial')} className="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 transition-all" title="Historial"><History size={18}/></button>
                                
                                {usuarioActual.rol === 'admin' && (
                                    <>
                                    <button onClick={() => setModalAbierto('backup')} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-amber-400 transition-colors" title="Respaldo"><Database size={20}/></button>
                                    <button onClick={() => setModalAbierto('config')} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-slate-200 transition-colors" title="ConfiguraciÃ³n"><Settings size={20}/></button>
                                    <button onClick={() => setModalAbierto('estaciones')} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-blue-400 transition-colors" title="Estaciones"><Monitor size={20}/></button>
                                    <button onClick={() => setModalAbierto('usuarios')} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-indigo-400 transition-colors"><UserCog size={20}/></button>
                                    <button onClick={() => setModalAbierto('inventario')} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-emerald-400 transition-colors"><Package size={20}/></button>
                                    </>
                                )}
                            <button onClick={() => setModalAbierto('clientes')} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-pink-400 transition-colors"><Users size={20}/></button>
                            <button onClick={() => setModalAbierto('legal')} className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-cyan-400 transition-colors" title="InformaciÃ³n y Legal"><Info size={20}/></button>
                                <div className="hidden md:flex items-center gap-2 mr-4 ml-2">
                                <div className="bg-slate-800 border border-slate-700 px-3 py-1 rounded-full text-xs flex items-center gap-2">
                                    <Shield size={12} className={usuarioActual.rol === 'admin' ? 'text-blue-400' : 'text-slate-500'}/>
                                        <span className="capitalize font-bold">{usuarioActual.nombre}</span>
                                    </div>
                                <button onClick={() => setModalAbierto('cambiar_pin')} className="bg-slate-800 hover:bg-slate-700 p-1.5 rounded-full text-slate-400 hover:text-white transition-colors"><Key size={12} /></button>
                                </div>
                            <button onClick={() => setUsuarioActual(null)} className="ml-2 bg-rose-900/20 text-rose-400 hover:bg-rose-900/40 p-2 rounded-full transition-colors"><LogOut size={18}/></button>
                            </div>
                        </div>
                    </nav>

                    {/* DASHBOARD */}
                    <main className="max-w-7xl mx-auto px-4 py-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {equipos.map(eq => {
                                const tiempoMs = calcularTiempo(eq);
                                const esPrepago = eq.modo === 'prepago';
                                const restante = eq.limiteTiempo - tiempoMs;
                                const alerta1Min = esPrepago && restante <= 60000 && restante > 0;
                                const finalizado = eq.estado === 'finalizado';
                                let cardClass = "bg-white/80 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-white/60 dark:border-slate-700/60 overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all duration-300 relative group";
                                if (esPrepago && !finalizado && !alerta1Min) cardClass += " ring-2 ring-indigo-400 bg-indigo-50/40 dark:bg-indigo-900/10";
                                if (alerta1Min) cardClass += " ring-2 ring-orange-400";
                                if (finalizado) cardClass += " alarm-active ring-2 ring-rose-500";

                                return (
                                    <div key={eq.id} className={cardClass}>
                                        <div className={`p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center ${eq.estado === 'ocupado' ? 'bg-indigo-50/50 dark:bg-indigo-900/20' : finalizado ? 'bg-rose-50/80 dark:bg-rose-900/20' : 'bg-transparent'}`}>
                                            <div className="flex items-center gap-2">
                                                {eq.tipo === 'PC' ? <Monitor size={18} /> : <Gamepad2 size={18} />}
                                                <span className="font-bold">{eq.nombre}</span>
                                            </div>
                                            <span className={`px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${eq.estado === 'libre' ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300'}`}>
                                                {finalizado ? 'TIEMPO FINALIZADO' : eq.estado}
                                            </span>
                                        </div>
                                        <div className="p-4">
                                            <div className="text-center mb-4 relative">
                                                {esPrepago && !finalizado && (
                                                    <div className="w-full bg-slate-200 rounded-full h-1.5 mb-2 overflow-hidden">
                                                        <div className={`h-full ${alerta1Min ? 'bg-orange-500' : 'bg-indigo-500'}`} style={{ width: `${Math.max(0, (restante / eq.limiteTiempo) * 100)}%`, transition: 'width 1s linear' }}></div>
                                                    </div>
                                                )}
                                                <div className={`text-3xl font-mono ${finalizado ? 'text-rose-600 dark:text-rose-400 font-bold' : alerta1Min ? 'text-orange-500 animate-pulse' : 'text-slate-800 dark:text-white'}`}>
                                                    {esPrepago && !finalizado ? new Date(Math.max(0, restante)).toISOString().substr(11, 8) : new Date(tiempoMs).toISOString().substr(11, 8) }
                                                </div>
                                                <div className="text-[10px] text-slate-400 uppercase font-bold tracking-wider mt-1">
                                                    {esPrepago ? (finalizado ? "SE REQUIERE COBRO" : "TIEMPO RESTANTE (PREPAGO)") : "TIEMPO TRANSCURRIDO"}
                                                </div>
                                            </div>
                                            <div className="flex justify-between items-center text-sm mb-4 bg-slate-50/80 dark:bg-slate-700/50 p-3 rounded-2xl border border-slate-100 dark:border-slate-600">
                                                <span className="text-slate-500 dark:text-slate-400">A Pagar:</span>
                                                <span className="font-bold text-xl text-slate-800 dark:text-white">${(calcularTotalRenta(eq) + eq.cuenta.reduce((a,i)=>a+(i.precio * (i.cantidad || 1)),0)).toFixed(2)}</span>
                                            </div>
                                            <div className="grid grid-cols-4 gap-2">
                                                {eq.estado === 'libre' ? (
                                                    <>
                                                        <button onClick={() => iniciarTiempoLibre(eq.id)} className="col-span-2 bg-emerald-500 hover:bg-emerald-600 text-white py-2.5 rounded-xl font-bold flex justify-center items-center gap-2 text-xs shadow-lg shadow-emerald-500/20 transition-all"><Play size={14}/> LIBRE</button>
                                                        <button onClick={() => abrirPrepago(eq.id)} className="col-span-2 bg-blue-500 hover:bg-blue-600 text-white py-2.5 rounded-xl font-bold flex justify-center items-center gap-2 text-xs shadow-lg shadow-blue-500/20 transition-all"><Timer size={14}/> PREPAGO</button>
                                                    </>
                                                ) : (
                                                    <>
                                                        {!finalizado && !esPrepago && (
                                                            <button onClick={() => togglePausa(eq.id)} className={`col-span-2 py-2.5 rounded-xl text-white font-bold flex justify-center items-center shadow-md transition-all ${eq.estado === 'ocupado' ? 'bg-amber-500 hover:bg-amber-600' : 'bg-emerald-500 hover:bg-emerald-600'}`}>
                                                                {eq.estado === 'ocupado' ? <Pause size={16}/> : <Play size={16}/>}
                                                            </button>
                                                        )}
                                                        {esPrepago && !finalizado && <div className="col-span-2 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 rounded-xl flex justify-center items-center text-xs font-bold border border-indigo-100 dark:border-indigo-800"><Lock size={12} className="mr-1"/> BLOQUEADO</div>}
                                                        {finalizado && <div className="col-span-2 bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 rounded-xl flex justify-center items-center text-xs font-bold border border-rose-100 dark:border-rose-800 animate-pulse"><Bell size={12} className="mr-1"/> Â¡COBRAR!</div>}
                                                        <button onClick={() => { if(verificarCaja()) { setEquipoSeleccionadoId(eq.id); setBusquedaEstacion(''); setModalAbierto('productos'); } }} className="bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 rounded-xl flex justify-center items-center transition-colors"><Coffee size={18}/></button>
                                                        <button onClick={() => { if((!esPrepago || finalizado) && verificarCaja()) { setEquipoSeleccionadoId(eq.id); setModalAbierto('cobrar'); } }} disabled={esPrepago && !finalizado} className={`${esPrepago && !finalizado ? 'bg-slate-300 dark:bg-slate-700 text-slate-400 cursor-not-allowed' : 'bg-emerald-500 hover:bg-emerald-600 text-white shadow-lg shadow-emerald-500/30 transform active:scale-95'} rounded-xl flex justify-center items-center transition-all`} title="Cobrar"><CircleDollarSign size={18}/></button>
                                                        <button onClick={() => iniciarIntercambio(eq.id)} className="col-span-2 mt-1 bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-600 py-1.5 rounded-lg text-xs font-bold flex justify-center items-center gap-1 hover:bg-slate-50 dark:hover:bg-slate-600 hover:text-blue-500 transition-colors"><ArrowRightLeft size={14}/> Mover</button>
                                                        <button onClick={() => cancelarServicio(eq.id)} className="col-span-2 mt-1 bg-white dark:bg-slate-700 text-slate-400 dark:text-slate-400 border border-slate-200 dark:border-slate-600 py-1.5 rounded-lg text-xs font-bold flex justify-center items-center gap-1 hover:text-rose-500 hover:border-rose-200 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-colors"><RotateCcw size={14} className="mr-1"/> Reset</button>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>

                    {/* FOOTER */}
                    <footer className="text-center py-8 text-slate-400 text-xs">
                        <p>&copy; {new Date().getFullYear()} {config.negocio?.nombre || "FasTPV"}. Todos los derechos reservados.</p>
                        <p className="mt-1 opacity-50">{SISTEMA}</p>
                    </footer>

                    {/* --- MODAL DE CAJA (NUEVO) --- */}
                    {modalAbierto === 'caja' && (
                        <div className="fixed inset-0 bg-slate-500/30 backdrop-blur-sm flex items-center justify-center z-[80] fade-anim">
                            <div className="bg-white/90 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-md overflow-hidden modal-anim border border-white/20">
                                <div className="p-4 border-b border-slate-200/50 flex justify-between items-center"><h2 className="font-bold flex items-center gap-2 text-slate-800"><Wallet className="text-blue-500"/> Control de Caja</h2><button onClick={() => setModalAbierto(null)} className="p-1 rounded-full hover:bg-slate-100"><X size={20} className="text-slate-500"/></button></div>
                                
                                {caja.activa ? (
                                    <div className="p-6">
                                        <div className="bg-emerald-50/50 border border-emerald-100 p-4 rounded-2xl text-center mb-4">
                                            <p className="text-sm text-emerald-700 font-bold uppercase">Turno Activo Desde</p>
                                            <p className="text-xs text-slate-500">{new Date(caja.inicio).toLocaleString()}</p>
                                        </div>
                                        <div className="space-y-3 mb-6">
                                            <div className="flex justify-between items-center border-b pb-2">
                                                <span className="text-slate-500">Fondo Inicial</span>
                                                <span className="font-bold text-lg">${caja.fondo.toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between items-center border-b pb-2">
                                                <span className="text-slate-500">Ventas Turno ({ventasTurno.length})</span>
                                                <span className="font-bold text-lg text-indigo-600">+${totalVentasTurno.toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between items-center bg-slate-100 p-2 rounded">
                                                <span className="text-slate-700 font-bold">TOTAL EN CAJA</span>
                                                <span className="font-black text-2xl text-slate-800">${(caja.fondo + totalVentasTurno).toFixed(2)}</span>
                                            </div>
                                        </div>
                                        <button onClick={cerrarCaja} className="w-full bg-rose-500 hover:bg-rose-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-rose-500/30 transition-all">Cerrar Turno / Corte de Caja</button>
                                    </div>
                                ) : (
                                    <div className="p-6">
                                        <p className="text-sm text-slate-500 mb-4 text-center">La caja estÃ¡ cerrada. Ingresa el fondo inicial para comenzar.</p>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">Monto Fondo Inicial</label>
                                        <div className="relative mb-6">
                                            <span className="absolute left-3 top-2.5 text-slate-400 font-bold">$</span>
                                            <input type="number" className="w-full border border-slate-200 bg-transparent rounded-xl p-2 pl-8 text-lg font-bold outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" placeholder="0.00" value={cajaForm.fondo} onChange={e => setCajaForm({...cajaForm, fondo: e.target.value})} autoFocus />
                                        </div>
                                        <button onClick={abrirCaja} className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-all">Iniciar Turno</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* --- MODAL HISTORIAL (VENTAS Y CORTES) --- */}
                    {modalAbierto === 'historial' && (
                        <div className="fixed inset-0 bg-slate-500/30 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col modal-anim border border-white/20 dark:border-slate-700 overflow-hidden">
                                <div className="p-4 border-b border-slate-200/50 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
                                    <h2 className="font-bold flex items-center gap-2 text-slate-800 dark:text-white"><History className="text-blue-500"/> Historial de Operaciones</h2>
                                    <button onClick={() => setModalAbierto(null)} className="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><X size={20} className="text-slate-500"/></button>
                                </div>
                                <div className="flex flex-1 overflow-hidden flex-col md:flex-row">
                                    {/* COLUMNA 1: VENTAS RECIENTES */}
                                    <div className="flex-1 flex flex-col border-r border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900">
                                        <div className="p-3 bg-indigo-50 dark:bg-indigo-900/20 border-b border-indigo-100 dark:border-indigo-800"><h3 className="font-bold text-indigo-800 dark:text-indigo-300 text-sm flex items-center gap-2"><Ticket size={16}/> Ventas Recientes</h3></div>
                                        <div className="flex-1 overflow-y-auto p-0">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold sticky top-0"><tr><th className="p-3">Folio</th><th className="p-3">Hora</th><th className="p-3">Cliente</th><th className="p-3 text-right">Total</th><th className="p-3 text-center">AcciÃ³n</th></tr></thead>
                                                <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                                                    {[...ventas].sort((a,b) => b.id - a.id).slice(0, 50).map(v => (
                                                        <tr key={v.id} className={`hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors ${v.cancelada ? 'opacity-50 bg-slate-50 dark:bg-slate-800/50' : ''}`}>
                                                            <td className="p-3 font-mono text-xs text-slate-500">{v.id.toString().slice(-4)}</td>
                                                            <td className="p-3 text-slate-600 dark:text-slate-300 text-xs">{new Date(v.fecha).toLocaleDateString()} {new Date(v.fecha).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                                                            <td className="p-3 font-medium text-slate-800 dark:text-white truncate max-w-[100px]">{v.cliente}</td>
                                                            <td className={`p-3 text-right font-bold ${v.cancelada ? 'text-slate-400 line-through' : 'text-emerald-600 dark:text-emerald-400'}`}>${v.total.toFixed(2)}</td>
                                                            <td className="p-3 text-center">
                                                                {v.cancelada ? <span className="text-[10px] bg-rose-100 text-rose-600 px-1.5 py-0.5 rounded font-bold">CANCELADA</span> : (
                                                                    <div className="flex justify-center gap-2">
                                                                        <button onClick={() => generarTicket(v, config.formatoTicket)} className="text-slate-400 hover:text-blue-500" title="Reimprimir"><Printer size={16}/></button>
                                                                        {usuarioActual.rol === 'admin' && new Date(v.fecha).toDateString() === new Date().toDateString() && (
                                                                            <button onClick={() => cancelarVenta(v.id)} className="text-slate-400 hover:text-rose-500" title="Cancelar Venta"><Ban size={16}/></button>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {/* COLUMNA 2: HISTORIAL CORTES */}
                                    <div className="w-full md:w-1/3 flex flex-col bg-slate-50 dark:bg-slate-800/50">
                                        <div className="p-3 bg-emerald-50 dark:bg-emerald-900/20 border-b border-emerald-100 dark:border-emerald-800"><h3 className="font-bold text-emerald-800 dark:text-emerald-300 text-sm flex items-center gap-2"><FileClock size={16}/> Cortes de Caja Anteriores</h3></div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                            {cortes.length === 0 ? <div className="text-center text-slate-400 py-10 text-sm">No hay cortes registrados</div> : cortes.map(c => (
                                                <div key={c.id} className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div><div className="font-bold text-slate-700 dark:text-white text-sm">{new Date(c.fecha).toLocaleDateString()}</div><div className="text-xs text-slate-400">{new Date(c.fecha).toLocaleTimeString()}</div></div>
                                                        <button onClick={() => reimprimirCorte(c)} className="text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 p-1.5 rounded transition-colors" title="Reimprimir Reporte"><Printer size={16}/></button>
                                                    </div>
                                                    <div className="flex justify-between text-xs text-slate-500 dark:text-slate-400 mb-1"><span>Fondo Inicial:</span><span>${c.fondo.toFixed(2)}</span></div>
                                                    <div className="flex justify-between text-xs text-slate-500 dark:text-slate-400 mb-1"><span>Ventas:</span><span className="text-emerald-600 font-bold">+${c.totalVentas.toFixed(2)}</span></div>
                                                    <div className="border-t dark:border-slate-700 mt-2 pt-2 flex justify-between font-bold text-sm text-slate-800 dark:text-white"><span>Total Caja:</span><span>${c.totalCaja.toFixed(2)}</span></div>
                                                    <div className="mt-2 text-[10px] text-slate-400 text-right">Por: {c.usuario}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL CONFIGURACION (GENERAL Y PRECIOS) --- */}
                    {modalAbierto === 'config' && (
                        <div className="fixed inset-0 bg-slate-500/30 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white/90 dark:bg-slate-900/90 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col modal-anim border border-white/20 dark:border-slate-700">
                                <div className="p-4 border-b border-slate-200/50 dark:border-slate-700 flex justify-between items-center"><h2 className="font-bold flex items-center gap-2 text-slate-800 dark:text-white"><Settings className="text-slate-500"/> ConfiguraciÃ³n General</h2><button onClick={() => setModalAbierto(null)} className="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><X size={20} className="text-slate-500 dark:text-slate-400"/></button></div>
                                
                                {/* NUEVO: CONFIGURACION GENERAL */}
                                <div className="p-4 bg-amber-50/50 dark:bg-amber-900/20 border-b border-amber-100/50 dark:border-amber-800/50 flex flex-col gap-4">
                                    <div className="space-y-3">
                                        <h3 className="font-bold text-amber-800 dark:text-amber-400 text-xs uppercase flex items-center gap-2"><Building size={14}/> Datos del Negocio (Ticket)</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase">Nombre Empresa</label>
                                                <input className="w-full border p-1.5 rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={config.negocio.nombre} onChange={e => setConfig({...config, negocio: {...config.negocio, nombre: e.target.value}})} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase">RFC</label>
                                                <input className="w-full border p-1.5 rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={config.negocio.rfc} onChange={e => setConfig({...config, negocio: {...config.negocio, rfc: e.target.value}})} />
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="text-[10px] font-bold text-slate-500 uppercase">DirecciÃ³n Fiscal</label>
                                                <input className="w-full border p-1.5 rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={config.negocio.direccion} onChange={e => setConfig({...config, negocio: {...config.negocio, direccion: e.target.value}})} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase">RÃ©gimen Fiscal</label>
                                                <input className="w-full border p-1.5 rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={config.negocio.regimen} onChange={e => setConfig({...config, negocio: {...config.negocio, regimen: e.target.value}})} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase">Lugar ExpediciÃ³n</label>
                                                <input className="w-full border p-1.5 rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={config.negocio.lugarExpedicion} onChange={e => setConfig({...config, negocio: {...config.negocio, lugarExpedicion: e.target.value}})} />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-center justify-between">
                                        <div className="text-sm text-yellow-800">
                                            <span className="font-bold block">Tarifa MÃ­nima Global</span>
                                            <span className="text-xs opacity-75">Cobro mÃ­nimo al iniciar renta</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-yellow-900">$</span>
                                            <input type="number" className="w-20 border border-yellow-300 dark:border-yellow-700 bg-white dark:bg-slate-800 rounded p-1 text-center font-bold dark:text-white" value={config.tarifaMinima} onChange={e => setConfig({...config, tarifaMinima: parseFloat(e.target.value) || 0})} />
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <div className="text-sm text-yellow-800">
                                            <span className="font-bold block">Formato Ticket Predeterminado</span>
                                            <span className="text-xs opacity-75">Selecciona el tamaÃ±o de impresiÃ³n</span>
                                        </div>
                                        <select className="border border-yellow-300 dark:border-yellow-700 rounded p-1 text-sm font-bold bg-white dark:bg-slate-800 dark:text-white" value={config.formatoTicket || '58mm'} onChange={e => setConfig({...config, formatoTicket: e.target.value})}>
                                            <option value="58mm">Ticket TÃ©rmico (58mm)</option>
                                            <option value="LETTER">Carta (PDF Completo)</option>
                                        </select>
                                    </div>
                                    <div className="pt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <button onClick={() => setModalAbierto('config_ticket')} className="w-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 py-2 rounded-lg font-bold flex items-center justify-center gap-2 border border-slate-200 dark:border-slate-700 transition-colors"><FileText size={18}/> DiseÃ±o Ticket</button>
                                        <button onClick={() => setModalAbierto('config_precios')} className="w-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 py-2 rounded-lg font-bold flex items-center justify-center gap-2 border border-slate-200 dark:border-slate-700 transition-colors"><DollarSign size={18}/> Precios</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL CONFIG PRECIOS --- */}
                    {modalAbierto === 'config_precios' && (
                        <div className="fixed inset-0 bg-slate-500/30 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white/90 dark:bg-slate-900/90 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-2xl modal-anim border border-white/20 dark:border-slate-700">
                                <div className="p-4 border-b border-slate-200/50 dark:border-slate-700 flex justify-between items-center">
                                    <h2 className="font-bold flex items-center gap-2 text-slate-800 dark:text-white"><DollarSign className="text-slate-500"/> ConfiguraciÃ³n de Precios</h2>
                                    <button onClick={() => setModalAbierto('config')} className="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowRightLeft size={20} className="text-slate-500 dark:text-slate-400"/></button>
                                </div>
                                <div className="p-6 bg-white dark:bg-slate-800 rounded-b-3xl">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase">ImpresiÃ³n B/N</label>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div><span className="text-[10px] text-slate-400 block">BÃ¡sica</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.impresion.bn.B} onChange={e => setConfig({...config, precios: {...config.precios, impresion: {...config.precios.impresion, bn: {...config.precios.impresion.bn, B: parseFloat(e.target.value)}}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">Media</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.impresion.bn.M} onChange={e => setConfig({...config, precios: {...config.precios, impresion: {...config.precios.impresion, bn: {...config.precios.impresion.bn, M: parseFloat(e.target.value)}}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">Alta</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.impresion.bn.G} onChange={e => setConfig({...config, precios: {...config.precios, impresion: {...config.precios.impresion, bn: {...config.precios.impresion.bn, G: parseFloat(e.target.value)}}}})} /></div>
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase">ImpresiÃ³n Color</label>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div><span className="text-[10px] text-slate-400 block">BÃ¡sica</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.impresion.color.B} onChange={e => setConfig({...config, precios: {...config.precios, impresion: {...config.precios.impresion, color: {...config.precios.impresion.color, B: parseFloat(e.target.value)}}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">Media</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.impresion.color.M} onChange={e => setConfig({...config, precios: {...config.precios, impresion: {...config.precios.impresion, color: {...config.precios.impresion.color, M: parseFloat(e.target.value)}}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">Alta</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.impresion.color.G} onChange={e => setConfig({...config, precios: {...config.precios, impresion: {...config.precios.impresion, color: {...config.precios.impresion.color, G: parseFloat(e.target.value)}}}})} /></div>
                                            </div>
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase">Otros Servicios</label>
                                            <div className="grid grid-cols-4 gap-2">
                                                <div><span className="text-[10px] text-slate-400 block">WiFi</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.otros.wifi} onChange={e => setConfig({...config, precios: {...config.precios, otros: {...config.precios.otros, wifi: parseFloat(e.target.value)}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">AsesorÃ­a</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.otros.asesoria} onChange={e => setConfig({...config, precios: {...config.precios, otros: {...config.precios.otros, asesoria: parseFloat(e.target.value)}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">Oficio(+)</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.extras.oficio} onChange={e => setConfig({...config, precios: {...config.precios, extras: {...config.precios.extras, oficio: parseFloat(e.target.value)}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">Tabloide(x)</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.extras.tabloide} onChange={e => setConfig({...config, precios: {...config.precios, extras: {...config.precios.extras, tabloide: parseFloat(e.target.value)}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">Escaneo Carta</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.otros.escaneo?.carta} onChange={e => setConfig({...config, precios: {...config.precios, otros: {...config.precios.otros, escaneo: {...config.precios.otros.escaneo, carta: parseFloat(e.target.value)}}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">Escaneo Oficio</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.otros.escaneo?.oficio} onChange={e => setConfig({...config, precios: {...config.precios, otros: {...config.precios.otros, escaneo: {...config.precios.otros.escaneo, oficio: parseFloat(e.target.value)}}}})} /></div>
                                                <div><span className="text-[10px] text-slate-400 block">EnvÃ­o Digital</span><input type="number" className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-900 rounded p-1 text-center font-bold dark:text-white" value={config.precios.otros.envio} onChange={e => setConfig({...config, precios: {...config.precios, otros: {...config.precios.otros, envio: parseFloat(e.target.value)}}})} /></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="pt-4 border-t dark:border-slate-700 mt-4">
                                        <button onClick={() => setModalAbierto('config')} className="w-full bg-slate-800 text-white py-2 rounded-lg font-bold">Volver a ConfiguraciÃ³n</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL CONFIG TICKET --- */}
                    {modalAbierto === 'config_ticket' && (
                        <div className="fixed inset-0 bg-slate-500/30 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white/90 dark:bg-slate-900/90 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-lg modal-anim border border-white/20 dark:border-slate-700">
                                <div className="p-4 border-b border-slate-200/50 dark:border-slate-700 flex justify-between items-center">
                                    <h2 className="font-bold flex items-center gap-2 text-slate-800 dark:text-white"><FileText className="text-slate-500"/> DiseÃ±o de Ticket</h2>
                                    <button onClick={() => setModalAbierto('config')} className="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><ArrowRightLeft size={20} className="text-slate-500 dark:text-slate-400"/></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">Encabezados de Columnas</label>
                                        <div className="grid grid-cols-4 gap-2">
                                            <input className="border p-2 rounded text-xs dark:bg-slate-800 dark:border-slate-600 dark:text-white" placeholder="Cant" value={config.ticketConfig.headers.cant} onChange={e => setConfig({...config, ticketConfig: {...config.ticketConfig, headers: {...config.ticketConfig.headers, cant: e.target.value}}})} />
                                            <input className="border p-2 rounded text-xs dark:bg-slate-800 dark:border-slate-600 dark:text-white" placeholder="Desc" value={config.ticketConfig.headers.desc} onChange={e => setConfig({...config, ticketConfig: {...config.ticketConfig, headers: {...config.ticketConfig.headers, desc: e.target.value}}})} />
                                            <input className="border p-2 rounded text-xs dark:bg-slate-800 dark:border-slate-600 dark:text-white" placeholder="P.U." value={config.ticketConfig.headers.pu} onChange={e => setConfig({...config, ticketConfig: {...config.ticketConfig, headers: {...config.ticketConfig.headers, pu: e.target.value}}})} />
                                            <input className="border p-2 rounded text-xs dark:bg-slate-800 dark:border-slate-600 dark:text-white" placeholder="Total" value={config.ticketConfig.headers.importe} onChange={e => setConfig({...config, ticketConfig: {...config.ticketConfig, headers: {...config.ticketConfig.headers, importe: e.target.value}}})} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">Separador de Secciones</label>
                                        <input className="w-full border p-2 rounded text-sm font-mono dark:bg-slate-800 dark:border-slate-600 dark:text-white" maxLength="1" placeholder="Ej. - o =" value={config.ticketConfig.separador} onChange={e => setConfig({...config, ticketConfig: {...config.ticketConfig, separador: e.target.value}})} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">Mensaje Final</label>
                                        <input className="w-full border p-2 rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" placeholder="Gracias por su compra" value={config.ticketConfig.mensajeFinal} onChange={e => setConfig({...config, ticketConfig: {...config.ticketConfig, mensajeFinal: e.target.value}})} />
                                    </div>
                                    <div className="pt-4 border-t dark:border-slate-700">
                                        <button onClick={() => setModalAbierto('config')} className="w-full bg-slate-800 text-white py-2 rounded-lg font-bold">Volver a ConfiguraciÃ³n</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL ESTACIONES (CRUD) --- */}
                    {modalAbierto === 'estaciones' && (
                        <div className="fixed inset-0 bg-slate-500/30 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white/90 dark:bg-slate-900/90 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col modal-anim border border-white/20 dark:border-slate-700 overflow-hidden">
                                <div className="p-4 border-b border-slate-200/50 dark:border-slate-700 flex justify-between items-center shrink-0"><h2 className="font-bold flex items-center gap-2 text-slate-800 dark:text-white"><Monitor className="text-blue-500"/> Administrar Estaciones</h2><button onClick={() => setModalAbierto(null)} className="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800"><X size={20} className="text-slate-500 dark:text-slate-400"/></button></div>
                                
                                <div className="p-6 bg-slate-50/50 dark:bg-slate-900/50 flex flex-col md:flex-row gap-6 overflow-hidden flex-1">
                                    {/* Formulario */}
                                    <div className="w-full md:w-1/3 bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm h-fit space-y-4 border border-slate-100 dark:border-slate-700 shrink-0">
                                        <h3 className="font-bold text-sm text-slate-500 uppercase border-b dark:border-slate-700 pb-2">{estacionForm.id ? "Editar EstaciÃ³n" : "Nueva EstaciÃ³n"}</h3>
                                        
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Nombre</label>
                                            <input className="w-full border border-slate-200 dark:border-slate-700 bg-transparent dark:bg-slate-900 p-2 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 dark:text-white transition-all" placeholder="Ej. PC-01" value={estacionForm.nombre} onChange={e => setEstacionForm({...estacionForm, nombre: e.target.value})} />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Tipo</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                <button onClick={() => setEstacionForm({...estacionForm, tipo: 'PC'})} className={`p-2 rounded-xl border text-xs font-bold flex flex-col items-center gap-1 transition-all ${estacionForm.tipo === 'PC' ? 'bg-blue-50 border-blue-500 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400' : 'border-slate-200 dark:border-slate-700 text-slate-500'}`}><Monitor size={20}/> PC</button>
                                                <button onClick={() => setEstacionForm({...estacionForm, tipo: 'CONSOLA'})} className={`p-2 rounded-xl border text-xs font-bold flex flex-col items-center gap-1 transition-all ${estacionForm.tipo === 'CONSOLA' ? 'bg-purple-50 border-purple-500 text-purple-600 dark:bg-purple-900/20 dark:text-purple-400' : 'border-slate-200 dark:border-slate-700 text-slate-500'}`}><Gamepad2 size={20}/> Consola</button>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Precio por Hora</label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-2.5 text-slate-400 font-bold">$</span>
                                                <input type="number" className="w-full border border-slate-200 dark:border-slate-700 bg-transparent dark:bg-slate-900 p-2 pl-6 rounded-xl text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 dark:text-white transition-all" placeholder="0.00" value={estacionForm.precioHora} onChange={e => setEstacionForm({...estacionForm, precioHora: e.target.value})} />
                                            </div>
                                        </div>

                                        <button onClick={guardarEstacion} className="w-full bg-blue-500 text-white py-3 rounded-xl font-bold hover:bg-blue-600 shadow-lg shadow-blue-500/20 transition-all flex justify-center items-center gap-2"><Save size={18}/> {estacionForm.id ? "Actualizar" : "Crear EstaciÃ³n"}</button>
                                        {estacionForm.id && <button onClick={() => setEstacionForm({ id: null, nombre: '', tipo: 'PC', precioHora: '' })} className="w-full py-2 rounded text-xs text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">Cancelar EdiciÃ³n</button>}
                                    </div>

                                    {/* Grid de Estaciones */}
                                    <div className="w-full md:w-2/3 overflow-y-auto custom-scrollbar pr-2">
                                        {equipos.length === 0 ? (
                                            <div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-60"><Monitor size={48} className="mb-2 stroke-1"/><p>No hay estaciones registradas</p></div>
                                        ) : (
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                {equipos.map(e => (
                                                    <div key={e.id} className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 hover:shadow-md hover:border-blue-300 dark:hover:border-blue-700 transition-all group relative">
                                                        <div className="flex justify-between items-start mb-3">
                                                            <div className={`p-3 rounded-xl ${e.tipo === 'PC' ? 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400' : 'bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-400'}`}>{e.tipo === 'PC' ? <Monitor size={24}/> : <Gamepad2 size={24}/>}</div>
                                                            <div className="flex gap-1"><button onClick={() => prepararEdicionEstacion(e)} className="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg transition-colors" title="Editar"><Edit2 size={16}/></button><button onClick={() => eliminarEstacion(e.id)} className="p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/30 rounded-lg transition-colors" title="Eliminar"><Trash2 size={16}/></button></div>
                                                        </div>
                                                        <div><div className="font-bold text-slate-700 dark:text-slate-200 text-lg">{e.nombre}</div><div className="flex items-center gap-2 mt-1"><span className="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 uppercase">{e.tipo}</span><span className="text-xs font-mono text-slate-400">${e.precioHora}/hr</span></div></div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ... (RESTO DE MODALES EXISTENTES SIN CAMBIOS MAYORES) ... */}

                    {/* --- MODAL CONFIRMACION RESET --- */}
                    {confirmarResetId && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[80] fade-anim">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full modal-anim text-center">
                                <div className="mb-4 text-rose-600 flex justify-center"><AlertTriangle size={48}/></div>
                                <h3 className="font-bold text-lg mb-2 text-slate-800">Â¿Reiniciar EstaciÃ³n?</h3>
                                <p className="text-sm text-slate-500 mb-6">Se perderÃ¡ el tiempo y el consumo actual sin cobrar. Esta acciÃ³n no se puede deshacer.</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setConfirmarResetId(null)} className="flex-1 border py-2 rounded text-slate-600 font-bold hover:bg-slate-50">Cancelar</button>
                                    <button onClick={ejecutarReset} className="flex-1 bg-rose-600 text-white py-2 rounded font-bold hover:bg-rose-700 shadow-lg">SÃ­, Reiniciar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL VENTA DIRECTA --- */}
                    {modalAbierto === 'venta_directa' && (
                        <div className="fixed inset-0 bg-slate-500/30 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-6 fade-anim">
                            <div className="bg-white/80 backdrop-blur-3xl rounded-3xl shadow-2xl w-full max-w-7xl h-full sm:h-[90vh] flex flex-col overflow-hidden modal-anim border border-white/40 ring-1 ring-black/5">
                                {/* Header */}
                                <div className="p-4 flex justify-between items-center bg-slate-900 text-white shadow-md z-10">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-orange-500 p-2 rounded-xl shadow-lg shadow-orange-500/20"><Store size={24} className="text-white" /></div>
                                        <div><h2 className="font-bold text-lg leading-none text-white">Venta de Mostrador</h2><p className="text-xs text-slate-400">Clientes sin equipo asignado</p></div>
                                    </div>
                                    <button onClick={() => setModalAbierto(null)} className="hover:bg-slate-800 p-2 rounded-full text-slate-400 hover:text-white transition-colors"><X size={24} /></button>
                                </div>
                                <div className="flex flex-1 overflow-hidden bg-slate-50/50 dark:bg-slate-900/50 flex-col sm:flex-row">
                                    <div className="flex-1 flex flex-col sm:flex-row overflow-hidden">
                                        {/* Left Column: Inventario */}
                                        <div className="w-full sm:w-1/2 flex flex-col border-r border-slate-200/50 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50">
                                            <div className="p-3 border-b border-slate-100 dark:border-slate-700 flex flex-col gap-2">
                                                <div className="flex justify-between items-center"><h3 className="font-bold text-xs text-slate-500 uppercase flex items-center gap-2"><Package size={14}/> Inventario</h3></div>
                                                <input className="w-full border dark:border-slate-600 bg-white dark:bg-slate-900 p-1.5 rounded text-sm outline-none focus:border-orange-500 dark:text-white" placeholder="Buscar producto..." value={busquedaDirecta} onChange={e => setBusquedaDirecta(e.target.value)} />
                                            </div>
                                            <div className="flex-1 overflow-y-auto p-3">
                                                <div className="grid grid-cols-1 gap-2">
                                                    {catalogo.filter(p => p.nombre.toLowerCase().includes(busquedaDirecta.toLowerCase()) || (p.codigo && p.codigo.includes(busquedaDirecta))).map(prod => (
                                                        <button key={prod.id} disabled={prod.stock < 1} onClick={() => agregarProductoDirecto(prod)} className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-2xl hover:border-orange-300 hover:bg-orange-50/50 dark:hover:bg-orange-900/20 hover:shadow-md text-left disabled:opacity-50 transition-all group">
                                                            <span className="text-2xl">{prod.icon}</span>
                                                            <div className="min-w-0 flex-1">
                                                                <div className="text-sm font-bold text-slate-700 dark:text-slate-200 truncate group-hover:text-orange-700 dark:group-hover:text-orange-400">{prod.nombre}</div>
                                                                <div className="flex justify-between items-center mt-1">
                                                                    <span className="text-xs text-orange-600 font-bold bg-orange-50 px-2 py-0.5 rounded">${prod.precio}</span>
                                                                    <span className={`text-[10px] px-1.5 rounded font-bold ${prod.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300'}`}>Stock: {prod.stock}</span>
                                                                </div>
                                                            </div>
                                                            <PlusCircle size={20} className="text-slate-200 group-hover:text-orange-500"/>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                        {/* Right Column: Servicios */}
                                        <div className="w-full sm:w-1/2 flex flex-col bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700">
                                            <div className="p-3 border-b bg-indigo-50 dark:bg-indigo-900/20"><h3 className="font-bold text-xs text-indigo-700 dark:text-indigo-300 uppercase flex items-center gap-2"><Printer size={14}/> Servicios RÃ¡pidos</h3></div>
                                            <div className="p-4 space-y-4 overflow-y-auto flex-1">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-2">1. Selecciona Servicio</label>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        {[{ id: 'IMPRESION_BN', label: 'Imp. B/N', icon: <FileText size={18}/>, color: 'text-slate-600' }, { id: 'IMPRESION_COLOR', label: 'Imp. Color', icon: <Printer size={18}/>, color: 'text-pink-500' }, { id: 'ESCANEO', label: 'Escaneo', icon: <ScanBarcode size={18}/>, color: 'text-blue-500' }, { id: 'ENVIO', label: 'EnvÃ­o', icon: <Bluetooth size={18}/>, color: 'text-indigo-500' }].map(opt => (
                                                            <button key={opt.id} onClick={() => setServicioForm({...servicioForm, tipo: opt.id})} className={`p-2 rounded-lg border text-sm font-bold flex flex-col items-center gap-1 transition-all ${servicioForm.tipo === opt.id ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                                                                <div className={servicioForm.tipo === opt.id ? 'text-white' : opt.color}>{opt.icon}</div>{opt.label}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-3">
                                                    <button onClick={() => setServicioForm({ ...servicioForm, tipo: 'WIFI' })} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === 'WIFI' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                                                        <div className={servicioForm.tipo === 'WIFI' ? 'text-white' : 'text-emerald-500'}><Wifi size={20}/></div>WiFi (${config.precios.otros.wifi})
                                                    </button>
                                                    <button onClick={() => setServicioForm({ ...servicioForm, tipo: 'ASESORIA' })} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === 'ASESORIA' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                                                        <div className={servicioForm.tipo === 'ASESORIA' ? 'text-white' : 'text-amber-500'}><HandHelping size={20}/></div>AsesorÃ­a (${config.precios.otros.asesoria})
                                                    </button>
                                                </div>

                                                {(servicioForm.tipo === 'IMPRESION_BN' || servicioForm.tipo === 'IMPRESION_COLOR') && (
                                                    <div className="fade-anim">
                                                        <label className="block text-xs font-bold text-slate-500 mb-2">2. Intensidad / Tipo</label>
                                                        <div className="grid grid-cols-3 gap-2">
                                                            {[{ id: 'B', label: 'BÃ¡sica', price: config.precios.impresion[servicioForm.tipo === 'IMPRESION_BN' ? 'bn' : 'color']['B'] }, { id: 'M', label: 'Media', price: config.precios.impresion[servicioForm.tipo === 'IMPRESION_BN' ? 'bn' : 'color']['M'] }, { id: 'G', label: 'Alta', price: config.precios.impresion[servicioForm.tipo === 'IMPRESION_BN' ? 'bn' : 'color']['G'] }].map(cob => (
                                                                <button key={cob.id} onClick={() => setServicioForm({...servicioForm, cobertura: cob.id})} className={`p-2 rounded border text-center text-xs font-bold transition-all ${servicioForm.cobertura === cob.id ? 'bg-indigo-50 dark:bg-indigo-900/30 border-indigo-500 text-indigo-700 dark:text-indigo-300 ring-1 ring-indigo-500' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300'}`}>
                                                                    {cob.label}<br/><span className="text-slate-400 font-normal">${cob.price}</span>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl border border-slate-200 dark:border-slate-600">
                                                    {servicioForm.tipo !== 'ENVIO' && servicioForm.tipo !== 'WIFI' && servicioForm.tipo !== 'ASESORIA' && (
                                                        <div className="flex bg-white dark:bg-slate-800 p-1 rounded-lg border dark:border-slate-600 mb-3">
                                                            {['CARTA', 'OFICIO', 'TABLOIDE'].map(tam => ((servicioForm.tipo === 'ESCANEO' && tam === 'TABLOIDE') ? null : <button key={tam} onClick={() => setServicioForm({...servicioForm, tamano: tam})} className={`flex-1 py-1 text-[10px] rounded font-bold transition-all ${servicioForm.tamano === tam ? 'bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-300 shadow-sm transform scale-105' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>{tam}</button>))}
                                                        </div>
                                                    )}
                                                    <div className="flex gap-2 items-center mb-3">
                                                        <div className="flex-1"><label className="block text-[10px] font-bold text-slate-500 mb-1">Cant.</label><input type="number" min="1" className="w-full border dark:border-slate-600 bg-white dark:bg-slate-800 p-2 rounded-lg font-bold text-center outline-none focus:border-indigo-500 dark:text-white" value={servicioForm.cantidad} onChange={e => setServicioForm({...servicioForm, cantidad: parseInt(e.target.value) || 1})} /></div>
                                                        <div className="flex-[2] text-right"><div className="text-[10px] text-slate-400 uppercase font-bold">Total Item</div><div className="text-xl font-black text-slate-800 dark:text-white">${(calcularPrecio(servicioForm.tipo, servicioForm.tamano, servicioForm.cobertura, servicioForm.cantidad) * servicioForm.cantidad).toFixed(2)}</div></div>
                                                    </div>
                                                    <button onClick={agregarServicioDirecto} className="w-full bg-slate-900 hover:bg-black text-white py-2 rounded-lg font-bold shadow flex justify-center items-center gap-2 text-sm"><CheckCircle size={16}/> Agregar</button>
                                                </div>
                                                
                                                <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                                                    <label className="block text-xs font-bold text-slate-500 mb-2">Agregar Cargo Manual</label>
                                                    <div className="flex gap-2">
                                                        <input className="flex-1 border dark:border-slate-600 bg-white dark:bg-slate-800 p-2 rounded text-sm dark:text-white" placeholder="Concepto (ej. Engargolado)" value={manualItemForm.nombre} onChange={e => setManualItemForm({...manualItemForm, nombre: e.target.value})} />
                                                        <input className="w-20 border dark:border-slate-600 bg-white dark:bg-slate-800 p-2 rounded text-sm dark:text-white" type="number" placeholder="$" value={manualItemForm.precio} onChange={e => setManualItemForm({...manualItemForm, precio: e.target.value})} />
                                                        <button onClick={agregarManualDirecto} className="bg-slate-700 text-white px-3 rounded hover:bg-slate-800"><PlusCircle size={18}/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {/* Right Column: Carrito */}
                                    <div className="w-full sm:w-96 bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 flex flex-col shadow-2xl z-20 h-1/3 sm:h-auto border-t sm:border-t-0">
                                        <div className="p-4 bg-orange-50 dark:bg-orange-900/20 border-b border-orange-100 dark:border-orange-800 flex justify-between items-center"><div><h3 className="font-bold text-orange-800 dark:text-orange-300 text-sm uppercase">Carrito Mostrador</h3></div><span className="bg-orange-200 dark:bg-orange-800 text-orange-800 dark:text-orange-200 px-2 py-1 rounded-full text-xs font-bold">{carritoDirecto.length} Items</span></div>
                                        <div className="px-4 py-2 bg-white dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700">
                                            <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Cliente (Para Puntos)</label>
                                            <div className="flex gap-2">
                                                <select className="flex-1 border dark:border-slate-600 text-sm rounded p-1 bg-slate-50 dark:bg-slate-700 dark:text-white" value={ventaDirectaClienteId} onChange={e => setVentaDirectaClienteId(e.target.value)}>{clientes.map(c => <option key={c.id} value={c.id}>{c.nombre}</option>)}</select>
                                                <button onClick={() => setMostrarNuevoCliente(!mostrarNuevoCliente)} className="bg-indigo-100 text-indigo-600 p-1 rounded hover:bg-indigo-200" title="Nuevo Cliente"><UserPlus size={18}/></button>
                                            </div>
                                            {mostrarNuevoCliente && (<div className="mt-2 bg-indigo-50 p-2 rounded flex gap-2 fade-anim"><input className="flex-1 text-xs border rounded p-1" placeholder="Nombre Cliente" value={nuevoClienteNombre} onChange={e => setNuevoClienteNombre(e.target.value)} autoFocus /><button onClick={agregarClienteRapido} className="bg-indigo-600 text-white text-xs font-bold px-2 rounded hover:bg-indigo-700">OK</button></div>)}
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/50 dark:bg-slate-900/50">
                                            {carritoDirecto.length === 0 ? (<div className="flex flex-col items-center justify-center h-full text-slate-400 opacity-60"><ShoppingBag size={48} className="mb-2 stroke-1"/><span className="text-xs font-medium">Carrito vacÃ­o</span></div>) : (carritoDirecto.map((i) => (<div key={i.uid} className="bg-white dark:bg-slate-700 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-600 flex justify-between items-center group"><div><div className="font-bold text-sm text-slate-800 dark:text-white">{i.nombre}</div><div className="text-xs text-slate-400">{i.cantidad} x ${i.precio}</div></div><div className="flex items-center gap-3"><div className="font-bold text-emerald-600 dark:text-emerald-400 text-sm">${(i.precio * (i.cantidad || 1)).toFixed(2)}</div><div className="flex items-center"><button onClick={() => disminuirCantidadDirecto(i.uid)} className="p-1 text-slate-300 hover:text-amber-500 transition-colors" title="Disminuir"><Minus size={16}/></button><button onClick={() => eliminarItemDirecto(i.uid)} className="p-1 text-slate-300 hover:text-rose-500 transition-colors" title="Eliminar"><X size={16}/></button></div></div></div>)))}
                                        </div>
                                        <div className="bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 p-5 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-bold text-lg text-slate-700 dark:text-slate-200">Total a Cobrar</span>
                                                <span className="font-black text-3xl text-orange-600">${carritoDirecto.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0).toFixed(2)}</span>
                                            </div>
                                            
                                            {/* PAGO CON y CAMBIO en Venta Directa */}
                                            <div className="mb-4 bg-slate-50 dark:bg-slate-700 p-2 rounded border border-slate-100 dark:border-slate-600">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <label className="text-xs font-bold text-slate-500 dark:text-slate-400 w-20">Paga con:</label>
                                                    <input type="number" className="flex-1 border dark:border-slate-600 bg-white dark:bg-slate-800 p-1 rounded text-sm font-bold text-right dark:text-white" placeholder="$0.00" value={pagoConDirecto} onChange={e => setPagoConDirecto(e.target.value)}/>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <label className="text-xs font-bold text-slate-500 dark:text-slate-400 w-20">Cambio:</label>
                                                    <div className="flex-1 text-right text-lg font-black text-emerald-600">${(parseFloat(pagoConDirecto) - carritoDirecto.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)).toFixed(2)}</div>
                                                </div>
                                            </div>

                                            <button onClick={cobrarVentaDirecta} disabled={procesando || (parseFloat(pagoConDirecto) || 0) < carritoDirecto.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)} className={`w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-emerald-200 transition-all transform hover:-translate-y-0.5 active:translate-y-0 flex justify-center items-center gap-2 ${(procesando || (parseFloat(pagoConDirecto) || 0) < carritoDirecto.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)) ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}>
                                                {procesando ? <div className="spinner" style={{borderColor: 'rgba(255,255,255,0.3)', borderLeftColor: '#fff'}}></div> : <><CircleDollarSign size={24}/> COBRAR AHORA</>}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL INVENTARIO --- */}
                    {modalAbierto === 'inventario' && (
                        <div className="fixed inset-0 bg-black/50 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white dark:bg-slate-900 rounded-xl w-full max-w-5xl max-h-[90vh] flex flex-col shadow-2xl modal-anim border dark:border-slate-700">
                                <div className="bg-indigo-700 p-4 text-white flex justify-between items-center rounded-t-xl"><h2 className="font-bold flex items-center gap-2"><Package /> Inventario</h2><button onClick={()=>{ setModalAbierto(null); setShowCamera(false); }}><X/></button></div>
                                <div className="flex-1 p-6 bg-slate-50 dark:bg-slate-900 flex gap-6 overflow-hidden">
                                    <div className="w-1/3 bg-white dark:bg-slate-800 p-5 rounded-lg shadow-sm border dark:border-slate-700 h-fit space-y-4 overflow-y-auto">
                                        <h3 className="font-bold text-slate-700 dark:text-white border-b dark:border-slate-700 pb-2 flex justify-between items-center">{itemForm.id ? "Editar" : "Nuevo"} {itemForm.id && <button onClick={() => setItemForm({ id: null, nombre: '', precio: '', stock: '', categoria: 'General', codigo: '' })} className="text-xs text-indigo-600 underline">Cancelar</button>}</h3>
                                        <div className="border rounded bg-slate-100 overflow-hidden relative"><button onClick={() => setShowCamera(!showCamera)} className={`w-full py-2 text-xs font-bold flex justify-center items-center gap-2 ${showCamera ? 'bg-slate-200 text-slate-600' : 'bg-slate-800 text-white hover:bg-slate-900'}`}>{showCamera ? <><CameraOff size={14}/> Detener CÃ¡mara</> : <><Camera size={14}/> Usar CÃ¡mara / QR</>}</button>{showCamera && <div id="reader" className="w-full h-48 bg-black"></div>}</div>
                                        <div><label className="text-xs font-bold text-slate-500 dark:text-slate-400">Producto</label><input className="w-full border dark:border-slate-600 bg-white dark:bg-slate-700 dark:text-white p-2 rounded mt-1 outline-none focus:border-indigo-500" value={itemForm.nombre} onChange={e => setItemForm({...itemForm, nombre: e.target.value})} placeholder="Ej. Coca Cola" /></div>
                                        <div className="flex gap-2"><div className="flex-1"><label className="text-xs font-bold text-slate-500 dark:text-slate-400">Precio</label><input type="number" className="w-full border dark:border-slate-600 bg-white dark:bg-slate-700 dark:text-white p-2 rounded mt-1 outline-none focus:border-indigo-500" value={itemForm.precio} onChange={e => setItemForm({...itemForm, precio: e.target.value})} placeholder="0.00" /></div><div className="flex-1"><label className="text-xs font-bold text-slate-500 dark:text-slate-400">Stock</label><input type="number" className="w-full border dark:border-slate-600 bg-white dark:bg-slate-700 dark:text-white p-2 rounded mt-1 outline-none focus:border-indigo-500" value={itemForm.stock} onChange={e => setItemForm({...itemForm, stock: e.target.value})} placeholder="0" /></div></div>
                                        <div><label className="text-xs font-bold text-slate-500 dark:text-slate-400">CategorÃ­a</label><select className="w-full border dark:border-slate-600 bg-white dark:bg-slate-700 dark:text-white p-2 rounded mt-1 outline-none focus:border-indigo-500" value={itemForm.categoria} onChange={e => setItemForm({...itemForm, categoria: e.target.value})}><option value="General">General</option><option value="Bebidas">Bebidas</option><option value="Snacks">Snacks</option><option value="PapelerÃ­a">PapelerÃ­a</option><option value="TecnologÃ­a">TecnologÃ­a</option></select></div>
                                        <div><label className="text-xs font-bold text-slate-500 dark:text-slate-400">CÃ³digo</label><div className="relative"><input className="w-full border dark:border-slate-600 bg-slate-50 dark:bg-slate-700 dark:text-white p-2 pl-8 rounded mt-1 outline-none focus:border-indigo-500" value={itemForm.codigo} onChange={e => setItemForm({...itemForm, codigo: e.target.value})} placeholder="Escanear..." /><ScanBarcode size={16} className="absolute left-2.5 top-4 text-slate-400"/></div></div>
                                        <button onClick={guardarProductoInventario} className="w-full bg-indigo-600 text-white py-2.5 rounded font-bold hover:bg-indigo-700 shadow transition-all flex justify-center items-center gap-2"><Save size={18}/> Guardar</button>
                                    </div>
                                    <div className="w-2/3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border dark:border-slate-700 overflow-hidden flex flex-col">
                                        <div className="overflow-y-auto flex-1">
                                            <table className="w-full text-sm text-left text-slate-700 dark:text-slate-200">
                                                <thead className="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold sticky top-0 shadow-sm"><tr><th className="p-3">Producto</th><th className="p-3">CategorÃ­a</th><th className="p-3">Precio</th><th className="p-3 text-center">Stock</th><th className="p-3 text-center">Acciones</th></tr></thead>
                                                <tbody>
                                                    {catalogo.map(p => (
                                                        <tr key={p.id} className="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 group transition-colors">
                                                            <td className="p-3 font-medium flex items-center gap-2"><span className="text-lg">{p.icon}</span> <div><div>{p.nombre}</div><div className="text-[10px] text-slate-400 font-mono flex items-center gap-1">{p.codigo ? <><QrCode size={10}/> {p.codigo}</> : 'Sin cÃ³digo'}</div></div></td>
                                                            <td className="p-3 text-slate-500 dark:text-slate-400"><span className="bg-slate-100 dark:bg-slate-600 px-2 py-0.5 rounded-full text-xs">{p.categoria}</span></td>
                                                            <td className="p-3 font-bold text-slate-700 dark:text-slate-200">${p.precio.toFixed(2)}</td>
                                                            <td className="p-3 text-center"><span className={`font-bold px-2 py-0.5 rounded text-xs ${p.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}`}>{p.stock}</span></td>
                                                            <td className="p-3 flex justify-center gap-2"><button onClick={() => prepararEdicionProducto(p)} className="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded transition-colors" title="Editar"><Edit2 size={16}/></button><button onClick={() => eliminarProductoInventario(p.id)} className="p-1.5 text-rose-600 hover:bg-rose-50 rounded transition-colors" title="Eliminar"><Trash2 size={16}/></button></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL CLIENTES --- */}
                    {modalAbierto === 'clientes' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden modal-anim">
                                <div className="bg-slate-700 p-4 text-white flex justify-between items-center"><h2 className="font-bold flex gap-2"><Users/> Clientes</h2><button onClick={() => setModalAbierto(null)}><X/></button></div>
                                <div className="p-4 bg-slate-50">
                                    <div className="flex gap-2 mb-4"><input className="flex-1 border p-2 rounded" placeholder="Nombre Nuevo Cliente" value={clienteForm.nombre} onChange={e => setClienteForm({nombre: e.target.value})} /><button onClick={() => { if(clienteForm.nombre){ setClientes(p => [...p, {id: Date.now(), nombre: clienteForm.nombre, puntos: 0}]); setClienteForm({nombre:''}); }}} className="bg-slate-700 text-white px-4 rounded font-bold">Agregar</button></div>
                                    <div className="bg-white border rounded h-64 overflow-y-auto">
                                        {clientes.map(c => (
                                            <div key={c.id} className="p-3 border-b flex justify-between items-center hover:bg-slate-50">
                                                <div><div className="font-bold flex items-center gap-2">{c.nombre}{c.id === 1 && <span className="bg-slate-200 text-slate-500 text-[10px] px-1 rounded uppercase">PÃºblico</span>}</div><div className="text-xs text-slate-400">ID: {c.id}</div></div>
                                                <div className="flex items-center gap-3">{c.id !== 1 ? <span className="bg-amber-100 text-amber-700 px-2 py-1 rounded text-xs font-bold flex items-center gap-1"><Trophy size={12}/> {c.puntos} pts</span> : <span className="text-slate-300 text-xs italic">Sin Puntos</span>}{c.id !== 1 && <button onClick={() => setClientes(p => p.filter(x => x.id !== c.id))} className="text-rose-400 hover:text-rose-600"><Trash2 size={14}/></button>}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL USUARIOS --- */}
                    {modalAbierto === 'usuarios' && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col modal-anim">
                                <div className="bg-slate-800 p-4 text-white flex justify-between items-center rounded-t-xl"><h2 className="font-bold flex items-center gap-2"><UserCog /> Personal</h2><button onClick={() => setModalAbierto(null)}><X /></button></div>
                                <div className="p-6 bg-slate-50 flex gap-6 overflow-auto">
                                    <div className="w-1/3 bg-white p-4 rounded shadow-sm h-fit space-y-3 border">
                                        <h3 className="font-bold text-sm text-slate-500 uppercase">Nuevo Usuario</h3>
                                        <input className="w-full border p-2 rounded text-sm outline-none focus:border-indigo-500" placeholder="Nombre" value={usuarioForm.nombre} onChange={e => setUsuarioForm({...usuarioForm, nombre: e.target.value})} />
                                        <div className="relative"><input className="w-full border p-2 pl-8 rounded text-sm outline-none focus:border-indigo-500" placeholder="PIN" maxLength="4" value={usuarioForm.pin} onChange={e => setUsuarioForm({...usuarioForm, pin: e.target.value.replace(/\D/g,'')})} /><Lock size={14} className="absolute left-2.5 top-3 text-slate-400"/></div>
                                        <select className="w-full border p-2 rounded text-sm outline-none focus:border-indigo-500" value={usuarioForm.rol} onChange={e => setUsuarioForm({...usuarioForm, rol: e.target.value})}><option value="empleado">Empleado</option><option value="admin">Administrador</option></select>
                                        <button onClick={guardarUsuario} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 shadow transition-all">Crear</button>
                                    </div>
                                    <div className="w-2/3 bg-white rounded shadow-sm overflow-hidden border">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-100 text-slate-600 font-bold"><tr><th className="p-3">Nombre</th><th className="p-3">Rol</th><th className="p-3">PIN</th><th className="p-3"></th></tr></thead>
                                            <tbody>
                                                {usuarios.map(u => (
                                                    <tr key={u.id} className="border-b hover:bg-slate-50">
                                                        <td className="p-3 font-bold">{u.nombre}</td>
                                                        <td className="p-3"><span className={`px-2 py-0.5 rounded text-[10px] uppercase font-bold ${u.rol === 'admin' ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-600'}`}>{u.rol}</span></td>
                                                        <td className="p-3 font-mono text-slate-400">****</td>
                                                        <td className="p-3 text-right">{u.id !== 1 && <button onClick={() => eliminarUsuario(u.id)} className="text-rose-500 hover:bg-rose-50 p-1 rounded transition-colors"><Trash2 size={16}/></button>}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL PRODUCTOS Y SERVICIOS (SIDEBAR ESTACIONES) --- */}
                    {modalAbierto === 'productos' && eqSel && (
                        <div className="fixed inset-0 bg-slate-500/30 dark:bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                             <div className="bg-white/95 dark:bg-slate-900/95 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col overflow-hidden modal-anim border border-white/20 dark:border-slate-700">
                                <div className="p-4 flex justify-between items-center border-b border-slate-200/50 dark:border-slate-700">
                                    <h2 className="font-bold flex items-center gap-2 text-slate-800 dark:text-white"><ShoppingBag className="text-blue-500" /> {eqSel.nombre}</h2>
                                    <button onClick={() => setModalAbierto(null)} className="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400"><X /></button>
                                </div>
                                <div className="flex flex-1 overflow-hidden bg-slate-50/50 dark:bg-slate-900/50">
                                    <div className="flex-1 flex overflow-hidden mr-1">
                                        <div className="w-1/2 flex flex-col border-r border-slate-200/50 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50">
                                            <div className="p-3 border-b border-slate-100 dark:border-slate-700 flex flex-col gap-2">
                                                <div className="flex justify-between items-center"><h3 className="font-bold text-xs text-slate-500 uppercase flex items-center gap-2"><Package size={14}/> Inventario</h3></div>
                                                <input className="w-full border dark:border-slate-600 bg-white dark:bg-slate-900 p-1.5 rounded text-sm outline-none focus:border-cyan-500 dark:text-white" placeholder="Buscar producto..." value={busquedaEstacion} onChange={e => setBusquedaEstacion(e.target.value)} />
                                            </div>
                                            <div className="flex-1 overflow-y-auto p-3"><div className="grid grid-cols-1 gap-2">{catalogo.filter(p => p.nombre.toLowerCase().includes(busquedaEstacion.toLowerCase()) || (p.codigo && p.codigo.includes(busquedaEstacion))).map(prod => (<button key={prod.id} disabled={prod.stock < 1} onClick={() => agregarProductoACuenta(prod)} className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg hover:border-cyan-500 hover:bg-cyan-50 dark:hover:bg-cyan-900/20 hover:shadow-md text-left disabled:opacity-50 transition-all"><span className="text-2xl">{prod.icon}</span><div className="min-w-0 flex-1"><div className="text-sm font-bold text-slate-700 dark:text-slate-200 truncate">{prod.nombre}</div><div className="flex justify-between items-center mt-1"><span className="text-xs text-cyan-600 font-bold bg-cyan-50 px-2 py-0.5 rounded">${prod.precio}</span><span className={`text-[10px] px-1.5 rounded font-bold ${prod.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300'}`}>Stock: {prod.stock}</span></div></div><ChevronRight size={16} className="text-slate-300"/></button>))}</div></div>
                                        </div>
                                        <div className="w-1/2 flex flex-col bg-white dark:bg-slate-800">
                                            <div className="p-3 border-b bg-indigo-50 dark:bg-indigo-900/20"><h3 className="font-bold text-xs text-indigo-700 dark:text-indigo-300 uppercase flex items-center gap-2"><Printer size={14}/> Servicios RÃ¡pidos</h3></div>
                                            <div className="p-5 space-y-6 overflow-y-auto">
                                                <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">1. Selecciona Servicio</label><div className="grid grid-cols-2 gap-3">{[{ id: 'IMPRESION_BN', label: 'ImpresiÃ³n B/N', icon: <FileText size={20}/>, color: 'text-slate-600' }, { id: 'IMPRESION_COLOR', label: 'ImpresiÃ³n Color', icon: <Printer size={20}/>, color: 'text-pink-500' }, { id: 'ESCANEO', label: 'Escaneo', icon: <ScanBarcode size={20}/>, color: 'text-blue-500' }, { id: 'ENVIO', label: 'EnvÃ­o Digital', icon: <Bluetooth size={20}/>, color: 'text-indigo-500' }].map(opt => (<button key={opt.id} onClick={() => setServicioForm({...servicioForm, tipo: opt.id})} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === opt.id ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg ring-2 ring-indigo-200' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 shadow-sm'}`}><div className={servicioForm.tipo === opt.id ? 'text-white' : opt.color}>{opt.icon}</div>{opt.label}</button>))}</div></div>
                                                <div className="grid grid-cols-2 gap-3"><button onClick={() => setServicioForm({ ...servicioForm, tipo: 'WIFI' })} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === 'WIFI' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><div className={servicioForm.tipo === 'WIFI' ? 'text-white' : 'text-emerald-500'}><Wifi size={20}/></div>WiFi (${config.precios.otros.wifi})</button><button onClick={() => setServicioForm({ ...servicioForm, tipo: 'ASESORIA' })} className={`p-3 rounded-lg border text-sm font-bold flex flex-col items-center gap-2 transition-all hover:scale-105 ${servicioForm.tipo === 'ASESORIA' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><div className={servicioForm.tipo === 'ASESORIA' ? 'text-white' : 'text-amber-500'}><HandHelping size={20}/></div>AsesorÃ­a (${config.precios.otros.asesoria})</button></div>
                                                {(servicioForm.tipo === 'IMPRESION_BN' || servicioForm.tipo === 'IMPRESION_COLOR') && (<div className="fade-anim"><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 flex items-center gap-1"><Droplet size={12}/> 2. Cobertura de Tinta</label><div className="grid grid-cols-3 gap-2">{[{ id: 'B', label: 'BÃ¡sica', desc: 'Texto simple', price: config.precios.impresion[servicioForm.tipo === 'IMPRESION_BN' ? 'bn' : 'color']['B'] }, { id: 'M', label: 'Media', desc: 'Con imÃ¡genes', price: config.precios.impresion[servicioForm.tipo === 'IMPRESION_BN' ? 'bn' : 'color']['M'] }, { id: 'G', label: 'Alta', desc: 'Fotos / Full', price: config.precios.impresion[servicioForm.tipo === 'IMPRESION_BN' ? 'bn' : 'color']['G'] }].map(cob => (<button key={cob.id} onClick={() => setServicioForm({...servicioForm, cobertura: cob.id})} className={`p-2 rounded-lg border text-left transition-all ${servicioForm.cobertura === cob.id ? 'bg-indigo-50 dark:bg-indigo-900/30 border-indigo-500 ring-1 ring-indigo-500' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><div className="flex justify-between items-center mb-1"><span className={`font-bold text-xs ${servicioForm.cobertura === cob.id ? 'text-indigo-700 dark:text-indigo-300' : 'text-slate-700 dark:text-slate-300'}`}>{cob.label}</span><span className="text-[10px] font-bold bg-slate-100 dark:bg-slate-600 px-1.5 rounded text-slate-600 dark:text-slate-300">${cob.price}</span></div><div className="text-[10px] text-slate-400 leading-tight">{cob.desc}</div></button>))}</div></div>)}
                                                {servicioForm.tipo !== 'ENVIO' && servicioForm.tipo !== 'WIFI' && servicioForm.tipo !== 'ASESORIA' && (<div className="fade-anim delay-75"><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">3. TamaÃ±o de Papel</label><div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">{['CARTA', 'OFICIO', 'TABLOIDE'].map(tam => ((servicioForm.tipo === 'ESCANEO' && tam === 'TABLOIDE') ? null : <button key={tam} onClick={() => setServicioForm({...servicioForm, tamano: tam})} className={`flex-1 py-2 text-xs rounded-md font-bold transition-all ${servicioForm.tamano === tam ? 'bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-300 shadow-sm transform scale-105' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>{tam}</button>))}</div></div>)}
                                                <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-xl border border-slate-200 dark:border-slate-600"><div className="flex gap-4 items-end mb-3"><div className="w-24"><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Cantidad</label><input type="number" min="1" className="w-full border-2 border-slate-300 dark:border-slate-500 bg-white dark:bg-slate-800 p-2 rounded-lg font-bold text-center text-lg focus:border-indigo-500 outline-none dark:text-white" value={servicioForm.cantidad} onChange={e => setServicioForm({...servicioForm, cantidad: parseInt(e.target.value) || 1})} /></div><div className="flex-1 text-right"><div className="text-xs text-slate-400 uppercase font-bold">Total Estimado</div><div className="text-2xl font-black text-slate-800 dark:text-white tracking-tight">${(calcularPrecio(servicioForm.tipo, servicioForm.tamano, servicioForm.cobertura, servicioForm.cantidad) * servicioForm.cantidad).toFixed(2)}</div>{servicioForm.cantidad > 10 && servicioForm.tipo !== 'WIFI' && servicioForm.tipo !== 'ASESORIA' && <div className="text-[10px] text-emerald-600 font-bold bg-emerald-100 px-2 py-0.5 rounded-full inline-block mt-1">âœ¨ 10% Descuento Mayoreo</div>}</div></div><button onClick={agregarServicioACuenta} className="w-full bg-slate-900 hover:bg-black text-white py-3 rounded-lg font-bold shadow-lg flex justify-center items-center gap-2 transition-all transform active:scale-95"><CheckCircle size={20} className="text-emerald-400"/> Agregar a la Cuenta</button></div>
                                                <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700"><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">Agregar Cargo Manual</label><div className="flex gap-2"><input className="flex-1 border dark:border-slate-600 bg-white dark:bg-slate-800 p-2 rounded text-sm dark:text-white" placeholder="Concepto (ej. Engargolado)" value={manualItemForm.nombre} onChange={e => setManualItemForm({...manualItemForm, nombre: e.target.value})} /><input className="w-20 border dark:border-slate-600 bg-white dark:bg-slate-800 p-2 rounded text-sm dark:text-white" type="number" placeholder="$" value={manualItemForm.precio} onChange={e => setManualItemForm({...manualItemForm, precio: e.target.value})} /><button onClick={agregarManualACuenta} className="bg-slate-700 text-white px-3 rounded hover:bg-slate-800"><PlusCircle size={18}/></button></div></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="w-96 bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 flex flex-col shadow-2xl z-20"><div className="p-4 bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600 flex justify-between items-center"><div><h3 className="font-bold text-slate-700 dark:text-white text-sm uppercase tracking-wide">Cuenta Actual</h3><p className="text-[10px] text-slate-400">Resumen de consumos</p></div><span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs font-bold">{eqSel.cuenta.length} Items</span></div><div className="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/50 dark:bg-slate-900/50">{eqSel.cuenta.map((i) => (<div key={i.uid} className="bg-white dark:bg-slate-700 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-600 group relative hover:border-indigo-300 transition-all"><div className="flex justify-between items-center"><div><div className="font-bold text-sm text-slate-800 dark:text-white leading-tight">{i.nombre}</div>{i.esManual && <span className="text-[10px] bg-slate-100 dark:bg-slate-600 px-1 rounded text-slate-500 dark:text-slate-300">Manual</span>}<div className="text-[10px] text-slate-400 mt-0.5">{i.cantidad} x ${i.precio}</div></div><div className="flex items-center gap-3"><div className="font-bold text-emerald-600 dark:text-emerald-400 text-sm">${(i.precio * (i.cantidad || 1)).toFixed(2)}</div><div className="flex items-center"><button onClick={() => disminuirCantidadDeCuenta(i.uid)} className="p-1 text-slate-300 hover:text-amber-500 transition-colors" title="Disminuir"><Minus size={16}/></button><button onClick={() => eliminarProductoDeCuenta(i.uid)} className="p-1 text-slate-300 hover:text-rose-500 transition-colors" title="Eliminar"><X size={16}/></button></div></div></div></div>))}{eqSel.cuenta.length === 0 && (<div className="flex flex-col items-center justify-center h-full text-slate-400 opacity-60"><ShoppingBag size={48} className="mb-2 stroke-1"/><span className="text-xs font-medium">Carrito vacÃ­o</span><span className="text-[10px]">Agregue productos o servicios</span></div>)}</div><div className="bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 p-5 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]"><div className="space-y-1 mb-4"><div className="flex justify-between text-xs text-slate-500 dark:text-slate-400"><span>Subtotal Productos</span><span>${eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0).toFixed(2)}</span></div><div className="flex justify-between text-xs text-slate-500 dark:text-slate-400"><span>Renta Estimada (Tiempo)</span><span>${calcularTotalRenta(eqSel).toFixed(2)}</span></div></div><div className="flex justify-between items-center pt-3 border-t border-dashed border-slate-300 dark:border-slate-600 mb-4"><span className="font-bold text-lg text-slate-700 dark:text-white">Total a Pagar</span><span className="font-black text-2xl text-indigo-600 dark:text-indigo-400 tracking-tight">${(calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)).toFixed(2)}</span></div><button onClick={() => setModalAbierto('cobrar')} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-lg font-bold shadow-lg shadow-emerald-200 transition-all transform hover:-translate-y-0.5 active:translate-y-0 flex justify-center items-center gap-2"><Ticket size={18}/> Cobrar Cuenta</button></div></div>
                                </div>
                             </div>
                        </div>
                    )}

                    {/* --- MODAL DE CONFIRMACIÃ“N DE RESET --- */}
                    {confirmarResetId && (
                        <div className="fixed inset-0 bg-black/80 dark:bg-black/90 flex items-center justify-center z-[80] fade-anim">
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full modal-anim text-center">
                                <div className="mb-4 text-rose-600 flex justify-center"><AlertTriangle size={48}/></div>
                                <h3 className="font-bold text-lg mb-2 text-slate-800 dark:text-white">Â¿Reiniciar EstaciÃ³n?</h3>
                                <p className="text-sm text-slate-500 mb-6">Se perderÃ¡ el tiempo y el consumo actual sin cobrar. Esta acciÃ³n no se puede deshacer.</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setConfirmarResetId(null)} className="flex-1 border dark:border-slate-600 py-2 rounded text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-700">Cancelar</button>
                                    <button onClick={ejecutarReset} className="flex-1 bg-rose-600 text-white py-2 rounded font-bold hover:bg-rose-700 shadow-lg">SÃ­, Reiniciar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- OTROS MODALES (PIN, INTERCAMBIO, PREPAGO, COBRO, RESPALDO, ETC) MANTENIDOS --- */}
                    {modalAbierto === 'cambiar_pin' && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[70] p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden modal-anim">
                                <div className="bg-slate-800 p-4 text-white flex justify-between items-center"><h2 className="font-bold flex gap-2"><Key className="text-yellow-400"/> Seguridad</h2><button onClick={() => setModalAbierto(null)}><X/></button></div>
                                <div className="p-6 space-y-4">
                                    <p className="text-sm text-slate-500 mb-2">Cambiar contraseÃ±a para: <span className="font-bold text-slate-800">{usuarioActual.nombre}</span></p>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Nuevo PIN</label><input type="password" maxLength="4" className="w-full border-2 border-slate-200 rounded-lg p-2 text-center text-xl tracking-widest outline-none focus:border-indigo-500" value={pinData.nuevo} onChange={e => setPinData({...pinData, nuevo: e.target.value.replace(/\D/g,'')})} autoFocus /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Confirmar PIN</label><input type="password" maxLength="4" className="w-full border-2 border-slate-200 rounded-lg p-2 text-center text-xl tracking-widest outline-none focus:border-indigo-500" value={pinData.confirmar} onChange={e => setPinData({...pinData, confirmar: e.target.value.replace(/\D/g,'')})} /></div>
                                    <button onClick={actualizarPin} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg mt-4 flex justify-center items-center gap-2"><Save size={18}/> Guardar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {modalAbierto === 'intercambio' && eqSel && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                             <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md modal-anim">
                                <h2 className="font-bold mb-2 flex items-center gap-2 text-slate-700"><ArrowRightLeft/> Mover {eqSel.nombre}</h2>
                                <p className="text-sm text-slate-500 mb-4">Selecciona destino:</p>
                                <div className="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto">{equipos.filter(e => e.estado === 'libre' && e.id !== eqSel.id).map(e => (<button key={e.id} onClick={() => confirmarIntercambio(e.id)} className="border p-3 rounded hover:bg-indigo-50 font-bold text-left flex items-center gap-2">{e.tipo === 'PC' ? <Monitor size={16}/> : <Gamepad2 size={16}/>} {e.nombre}</button>))}</div>
                                <button onClick={() => setModalAbierto(null)} className="mt-4 w-full border py-2 rounded text-slate-500 hover:bg-slate-100">Cancelar</button>
                             </div>
                        </div>
                    )}

                    {modalAbierto === 'prepago' && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden modal-anim">
                                <div className="bg-indigo-600 p-4 text-white flex justify-between items-center"><h2 className="font-bold flex gap-2"><Timer/> Prepago</h2><button onClick={() => setModalAbierto(null)}><X/></button></div>
                                <div className="p-6 space-y-4">
                                    <div className="text-center text-sm text-slate-500 mb-4">Configurando: <span className="font-bold text-slate-800">{eqSel.nombre}</span><br/>Tarifa: ${eqSel.precioHora}/hr</div>
                                    
                                    <div className="grid grid-cols-3 gap-2 mb-2">
                                        {[30, 60, 90].map(m => <button key={m} onClick={() => setPrepagoData({ minutos: m, dinero: '' })} className={`py-2 rounded-lg border text-xs font-bold transition-all ${prepagoData.minutos == m ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100'}`}>{m} Min<br/><span className="font-normal opacity-70">${((m/60)*eqSel.precioHora).toFixed(2)}</span></button>)}
                                    </div>

                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Por Dinero ($)</label><div className="relative"><span className="absolute left-3 top-2.5 text-slate-400 font-bold">$</span><input type="number" className="w-full border-2 border-slate-200 rounded-lg p-2 pl-8 focus:border-indigo-500 outline-none font-bold text-lg" placeholder="0.00" value={prepagoData.dinero} onChange={e => setPrepagoData({ dinero: e.target.value, minutos: '' })} autoFocus /></div>{prepagoData.dinero && <p className="text-right text-xs text-emerald-600 font-bold mt-1">= {((parseFloat(prepagoData.dinero) / eqSel.precioHora) * 60).toFixed(0)} min</p>}</div>
                                    <div className="flex items-center gap-2"><div className="h-px bg-slate-200 flex-1"></div><span className="text-xs text-slate-400">O BIEN</span><div className="h-px bg-slate-200 flex-1"></div></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Por Tiempo (Minutos)</label><input type="number" className="w-full border-2 border-slate-200 rounded-lg p-2 focus:border-indigo-500 outline-none text-center" placeholder="Ej. 30" value={prepagoData.minutos} onChange={e => setPrepagoData({ minutos: e.target.value, dinero: '' })} /></div>
                                    <button onClick={aplicarPrepago} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg mt-4 flex justify-center items-center gap-2"><Play size={18}/> Iniciar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {modalAbierto === 'cobrar' && eqSel && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md modal-anim">
                                <div className="bg-slate-800 p-4 text-white flex justify-between items-center rounded-t-xl"><h2 className="font-bold flex items-center gap-2"><Ticket className="text-emerald-400" /> Checkout</h2><button onClick={() => setModalAbierto(null)}><X /></button></div>
                                <div className="p-6 space-y-4">
                                    <div><label className="text-xs font-bold text-slate-500 uppercase">Cliente</label><select className="w-full border p-2 rounded mt-1 text-sm bg-slate-50" value={checkoutData.clienteId || 1} onChange={e => setCheckoutData({ ...checkoutData, clienteId: parseInt(e.target.value) })}>{clientes.map(c => <option key={c.id} value={c.id}>{c.nombre} {c.id !== 1 ? `(${c.puntos} pts)` : ''}</option>)}</select></div>
                                    <div className="bg-slate-50 p-4 rounded border space-y-2 text-sm">
                                        <div className="flex justify-between"><span>Renta</span><span>${calcularTotalRenta(eqSel).toFixed(2)}</span></div>
                                        <div className="flex justify-between"><span>Productos</span><span>${eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0).toFixed(2)}</span></div>
                                        <div className="border-t pt-2 flex justify-between items-center text-lg font-bold text-slate-800"><span>TOTAL</span><span>${(calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)).toFixed(2)}</span></div>
                                        
                                        {/* PAGO CON y CAMBIO en EstaciÃ³n */}
                                        <div className="mt-2 pt-2 border-t border-slate-200">
                                            <div className="flex items-center gap-2 mb-1">
                                                <label className="text-xs font-bold text-slate-500 w-20">Paga con:</label>
                                                <input type="number" className="flex-1 border p-1 rounded text-sm font-bold text-right" placeholder="$0.00" value={checkoutData.pagoCon} onChange={e => setCheckoutData({...checkoutData, pagoCon: e.target.value})}/>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <label className="text-xs font-bold text-slate-500 w-20">Cambio:</label>
                                                <div className="flex-1 text-right text-lg font-black text-emerald-600">${(parseFloat(checkoutData.pagoCon) - (calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0))).toFixed(2)}</div>
                                            </div>
                                        </div>

                                    </div>
                                    {checkoutData.clienteId !== 1 ? (<div className="text-center text-xs text-emerald-600 bg-emerald-50 p-2 rounded border border-emerald-100">Este cliente ganarÃ¡ <b>{Math.floor((calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0)) * RATIO_PUNTOS)}</b> puntos con esta compra.</div>) : (<div className="text-center text-xs text-slate-400 bg-slate-50 p-2 rounded border border-slate-100">Cliente General: <b>No acumula puntos</b>.</div>)}
                                    <button onClick={procesarCobro} disabled={procesando || (parseFloat(checkoutData.pagoCon) || 0) < (calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0))} className={`w-full bg-emerald-600 text-white py-3 rounded-lg font-bold hover:bg-emerald-700 shadow-lg flex justify-center items-center gap-2 ${(procesando || (parseFloat(checkoutData.pagoCon) || 0) < (calcularTotalRenta(eqSel) + eqSel.cuenta.reduce((a,x)=>a+(x.precio*(x.cantidad||1)),0))) ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}>
                                        {procesando ? <div className="spinner" style={{borderColor: 'rgba(255,255,255,0.3)', borderLeftColor: '#fff'}}></div> : <><CheckCircle /> Terminar y Cobrar</>}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL BACKUP (RESPALDO) --- */}
                    {modalAbierto === 'backup' && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-anim">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden modal-anim">
                                <div className="bg-amber-500 p-4 text-white flex justify-between items-center"><h2 className="font-bold flex gap-2 items-center"><Database/> Respaldo y MigraciÃ³n</h2><button onClick={() => setModalAbierto(null)}><X/></button></div>
                                <div className="p-6 space-y-6">
                                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                        <h3 className="font-bold text-amber-800 mb-2 flex items-center gap-2"><Download size={20}/> Exportar Datos</h3>
                                        <p className="text-sm text-amber-700 mb-4">Descarga un archivo con toda la informaciÃ³n actual (Clientes, Ventas, ConfiguraciÃ³n) para guardarlo o llevarlo a otra PC.</p>
                                        <button onClick={handleExport} className="w-full bg-amber-600 hover:bg-amber-700 text-white py-2 rounded font-bold shadow transition-all">Descargar Respaldo (.json)</button>
                                    </div>

                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                        <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Upload size={20}/> Importar Datos</h3>
                                        <p className="text-sm text-slate-600 mb-4">Carga un archivo de respaldo previamente descargado. <span className="font-bold text-rose-600">Â¡Cuidado! Esto sobrescribirÃ¡ los datos actuales.</span></p>
                                        <input type="file" accept=".json" onChange={handleImport} className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- MODAL LEGAL / INFO --- */}
                    {modalAbierto === 'legal' && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[90] p-4 fade-anim">
                            <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg overflow-hidden modal-anim border border-white/10">
                                <div className="bg-slate-800 p-6 text-white text-center relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-blue-600 to-purple-600 opacity-50"></div>
                                    <div className="relative z-10">
                                        <h2 className="text-3xl font-black tracking-tight mb-1">FasTPV</h2>
                                        <p className="text-blue-100 text-sm font-mono">VersiÃ³n 1.0.0</p>
                                    </div>
                                    <button onClick={() => setModalAbierto(null)} className="absolute top-4 right-4 p-1 hover:bg-white/20 rounded-full transition-colors"><X size={20}/></button>
                                </div>
                                <div className="p-8 space-y-6 text-center">
                                    <div>
                                        <h3 className="font-bold text-slate-800 dark:text-white mb-2 flex items-center justify-center gap-2"><MapPin size={16} className="text-rose-500"/> Desarrollado por Ulisoft</h3>
                                        <p className="text-sm text-slate-500 dark:text-slate-400">Orgullosamente hecho en <span className="font-bold text-slate-700 dark:text-slate-300">Hidalgo, MÃ©xico</span> ðŸ‡²ðŸ‡½</p>
                                    </div>
                                    <div className="text-xs text-slate-400 dark:text-slate-500 space-y-2 border-t dark:border-slate-800 pt-4">
                                        <p><strong>Aviso de Privacidad:</strong> Este software almacena datos Ãºnicamente de manera local en el dispositivo. No se transmiten datos a servidores externos ni a terceros.</p>
                                        <p><strong>Licencia de Uso:</strong> Software propietario para gestiÃ³n de puntos de venta y control de tiempo. Prohibida su redistribuciÃ³n no autorizada.</p>
                                        <p>Â© {new Date().getFullYear()} Ulisoft Development. Todos los derechos reservados.</p>
                                    </div>
                                    <button onClick={() => setModalAbierto(null)} className="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-6 py-2 rounded-full font-bold text-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- TOASTS --- */}
                    <div className="fixed bottom-5 right-5 z-[100] flex flex-col gap-3 pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`pointer-events-auto w-80 bg-white dark:bg-slate-800 shadow-2xl rounded-xl p-4 flex items-start gap-3 border-l-4 transition-all ${t.type === 'success' ? 'border-emerald-500' : t.type === 'error' ? 'border-rose-500' : t.type === 'warning' ? 'border-amber-500' : 'border-blue-500'}`}>
                                <div className={`mt-0.5 ${t.type === 'success' ? 'text-emerald-500' : t.type === 'error' ? 'text-rose-500' : t.type === 'warning' ? 'text-amber-500' : 'text-blue-500'}`}>
                                    {t.type === 'success' ? <CheckCircle size={20}/> : t.type === 'error' ? <AlertCircle size={20}/> : t.type === 'warning' ? <AlertTriangle size={20}/> : <Info size={20}/>}
                                </div>
                                <div className="flex-1">
                                    <p className="text-sm font-bold text-slate-800 dark:text-white mb-0.5 capitalize">{t.type === 'info' ? 'InformaciÃ³n' : t.type}</p>
                                    <p className="text-xs text-slate-500 dark:text-slate-400 leading-relaxed whitespace-pre-line">{t.msg}</p>
                                </div>
                                <button onClick={() => removeToast(t.id)} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><X size={16}/></button>
                            </div>
                        ))}
                    </div>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CiberManager />);
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registrado con Ã©xito:', registration.scope))
                    .catch(err => console.log('SW fallo al registrar:', err));
            });
        }
    </script>
</body>
</html>